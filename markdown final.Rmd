---
title: "markdown final modélisation des systèmes biologiques"
author: "Antoine Hansenne"
date: "2024-05-27"
output:
  pdf_document: default
  html_document: default
---
co-author : Joppart Basil a apporté une grande aide technique dans ce rapport.

```{r}
setwd("C:\\crootbox-marshal\\crootbox-marshal")
```


### 1 : CHARGER LES BIBLIOTHÈQUES ET LES FICHIERS SOURCE  ###############################################################################

```{r}
library(tidyverse)
library(plyr)
library(readr)
library(data.table)
library(dplyr)
library(Matrix)
library(ggplot2)
library(tibble)
library(readxl)
library(forcats)
```

# Fonctions personnalisées
```{r}
source("inputs/functions/io_function.R") # CROOTBOX
source("inputs/functions/getSUF.R") # MARSHAL

```

# Mettre à jour le fichier exécutable crootbox si nécessaire
# WINDOWS
```{r}
file.copy("inputs/crootbox_source/crootbox.exe", 
          "inputs/crootbox.exe", 
          overwrite = T)
```
#Introduction

Dans le cadre du cours LBRAI2219 "Modélisations des systèmes biologiques", cette étude utilise le modèle APSIM (Agricultural Production Systems sIMulator) pour simuler la croissance des cultures sous différentes conditions d'humidité du sol. La modélisation des systèmes biologiques est une approche essentielle pour comprendre et prédire les interactions complexes entre les plantes, le sol et l'atmosphère. Elle permet de tester divers scénarios de gestion des ressources sans recourir à des expérimentations coûteuses et longues.

La modélisation offre la capacité de fournir des informations détaillées sur la manière dont les cultures réagissent aux variations environnementales, notamment en période de sécheresse. En simulant ces conditions, nous pouvons évaluer l'impact qu'ont la profondeur des racines sur les processus d'approvisionnement et de demande en eau des plantes. Cette compréhension permets d'optimiser les pratiques d'irrigation et développer des stratégies agricoles résilientes, particulièrement nécessaire dans un contexte de changement climatique. Les résultats de cette étude peuvent améliorer la gestion de l'eau et garantir la productivité des cultures, contribuant ainsi à la sécurité alimentaire et à la durabilité des systèmes agricoles.

#Matériels et méthodes

Durant ce rapport, nous utiliserons différents logiciels. CrootBox servira à modéliser la structure ainsi que l'anatomie d'un système racinaire. Marshall servira à apporter une dimensions hydraulique aux modèle anatomique et architecturaux. Apsim servira à modéliser la croissance d'une culture durant un intervalle de temps définis. 

Une fois tous ces logiciels fonctionnels, nous les associerons afin d'avoir une vue d'ensemble sur les caractéristiques racinaires tous au long de la croissance de la plante. 

## 2 : Modélisation de l'architecture racinaire #####################################################################################

Dans cette section, 3 modèles seront modélisés succsessivement afin de proposer une analyse du système racinaire du Maïs ainsi que ces propriétés hydrauliques associées. 

3 Modèles seront produits afin d'appuyer les observations ainsi que de les comparer par la suite. 
Pour chaque modèle, le logiciel CrootBox sera utilisé pour modéliser l'architecture ainsi que l'anatomie racinaire d'un plant de Maïs. Ensuite, le modèle MARSHAL permettra d'évaluer les propriétés hydrauliques du système racinaire. Pour cela, ce modèle calculera 3 différents paramètres que sont, la conductivité hydraulique ('kr'), la capacité de transpiration ('tact') et le facteur de satisfaction d'usage de l'eau ('Suf').


### 2.1 : premier modèle #####################################################################################

# chargement des ensembles de paramètres par défaut pour la simulation CRootBox 
```{r}
rparam1 <- read_rparam(path = "inputs/crootbox_source/modelparameter/maize_p1.rparam")
pparam1 <- read_pparam(path = "inputs/crootbox_source/modelparameter/maize_p1.pparam")
```


# Vérifier les paramètres des fichiers
```{r}
head(rparam1)
```


# Run crootbox
```{r}
system("inputs/crootbox.exe") # Run crootbox for windows
```


# résultats de la simulation
```{r}
rootsystem_1 <- fread("outputs/current_rootsystem.txt", header = T)

```

# Plot l'architecture du système racinaire
```{r}
rootsystem_1 %>%
  ggplot() +
  theme_classic() +
  geom_segment(aes(x = x1, y = z1, xend = x2, yend = z2), alpha=0.8) +
  coord_fixed()
```


#Enregistrer le plot du système racinaire
```{r}
rootsystem_plot <- fread("outputs/current_rootsystem.txt", header = T)
plot <- rootsystem_plot %>%
  ggplot() +
  theme_classic() +
  geom_segment(aes(x = x1, y = z1, xend = x2, yend = z2), alpha=0.8) +
  coord_fixed() +
  ggtitle("Architecture of the root system")  

save_path <- "C:\\crootbox-marshal\\crootbox-marshal\\outputs\\images\\root_system_architecture_plot_1.png"


ggsave(save_path, plot, width = 6, height = 4, units = "in")
ggsave("root_system_plot_1.png", plot, width = 6, height = 4, units = "in")
```


# Plot l'anatomie du système racinaire

# Recoder la colonne "type" avec des noms descriptifs
```{r}
rootsystem_anat <- rootsystem_1 %>%
  mutate(type = recode(type, 
                       `1` = "Tap root", 
                       `2` = "Lateral", 
                       `3` = "Second-order lateral", 
                       `4` = "Basal root"))
```


# s'assurer que le type est bien un facteur
```{r}
rootsystem_anat$type <- as.factor(rootsystem_anat$type)
```


# définition des couleurs
```{r}
my_colors <- c("Tap root" = "blue", "Lateral" = "red", "Second-order lateral" = "yellow", "Basal root" = "orange")
```


# Plot le système racinaire
```{r}
rootsystem_anat %>%
  ggplot() +
  theme_classic() +
  geom_segment(aes(x = x1, y = z1, xend = x2, yend = z2, col = type), alpha = 0.9) +
  coord_fixed() +
  scale_color_manual(name = "Root Type", values = my_colors)  # Change legend name and colors
```


#sauvegarde du plot du système racinaire
```{r}
plot <- rootsystem_anat %>%
  ggplot() +
  theme_classic() +
  geom_segment(aes(x = x1, y = z1, xend = x2, yend = z2, col = type), alpha = 0.8) +
  coord_fixed() +
  scale_color_manual(name = "Root Type", values = my_colors) +  # Change legend name and colors
  ggtitle("Anatomy of the root system") 

save_path <- "C:\\crootbox-marshal\\crootbox-marshal\\outputs\\images\\root_system_anatomy_plot_1.png"

ggsave(save_path, plot, width = 6, height = 4, units = "in")
ggsave("root_system_plot_1.png", plot, width = 6, height = 4, units = "in")
```


#  chargement des ensembles de paramètres par défaut pour la simulation MARSHAL
```{r}
psiCollar <- -15000 #force initiale de pression tirant l'eau hors de la plante
soil <- read_csv("inputs/soil.csv")
conductivities <- read_csv("inputs/conductivities.csv")

head(conductivities)
print(soil)
```


# Run MARSHAL
```{r}
hydraulics <- getSUF(rootsystem_1, conductivities, soil, psiCollar)
```


# Mapper les résultats à l'échelle du segment sur le système racinaire
```{r}
hydraulic_archi_1 <- hydraulics$root_system
hydraulic_archi_1$suf <- hydraulics$suf[,1]
hydraulic_archi_1$kr <- hydraulics$kr[,1]
hydraulic_archi_1$kx <- hydraulics$kx[,1]
hydraulic_archi_1$jr <- hydraulics$jr[,1]
hydraulic_archi_1$jxl <- hydraulics$jxl[,1]
```


# Obtenir les résultats à l'échelle de la plante

```{r}
print(paste0("Root system conductivity = ",hydraulics$krs))
print(paste0("Root system transpiration = ",hydraulics$tact))
hydraulics_krs_1 <- hydraulics$krs
```



# Plot les résultats
```{r}
hydraulic_archi_1 %>%
  ggplot() +
  theme_classic() +
  geom_segment(aes(x = x1, y = z1, xend = x2, yend = z2, col = suf), alpha=0.8) +
  scale_color_viridis_c() + 
  coord_fixed()


plot <- hydraulic_archi_1 %>%
  ggplot() +
  theme_classic() +
  geom_segment(aes(x = x1, y = z1, xend = x2, yend = z2, col = suf), alpha=0.8) +
  scale_color_viridis_c() + 
  coord_fixed() +
  ggtitle("SUF of the root system")  
save_path <- "C:\\crootbox-marshal\\crootbox-marshal\\outputs\\images\\hydraulic_archi_plot_Suf_1.png"


ggsave(save_path, plot, width = 6, height = 4, units = "in")
ggsave("hydraulic_archi_1_1.png", plot, width = 6, height = 4, units = "in")


hydraulic_archi_1 %>%
  ggplot() +
  theme_classic() +
  geom_segment(aes(x = x1, y = z1, xend = x2, yend = z2, col = kr), alpha=0.8) +
  scale_color_viridis_c() + 
  coord_fixed()

plot <- hydraulic_archi_1 %>%
  ggplot() +
  theme_classic() +
  geom_segment(aes(x = x1, y = z1, xend = x2, yend = z2, col = kr), alpha=0.8) +
  scale_color_viridis_c() + 
  coord_fixed() +
  ggtitle("Kr of the root system")

save_path <- "C:\\crootbox-marshal\\crootbox-marshal\\outputs\\images\\hydraulic_archi_plot_Kr_1.png"

ggsave(save_path, plot, width = 6, height = 4, units = "in")
ggsave("hydraulic_archi_1_2.png", plot, width = 6, height = 4, units = "in")
```

#Observations

On observe un SUF plus important à l'extrémité des racines par rapport à leur base. Cela peut s'expliquer par le fait que les racines croissent via le méristème apical qui est le centre de divisions des cellules et permettant à la racine de grandir. Cet endroit, nécessite donc une utilisation plus aiguisée de l'eau afin de remplir ce rôle d'extension. 

Pour le Krs, la conductivité semble plus importante au plus les racines sont profondes. Cependant, on observe qu'entre -40 à -30cm certaines racines basales perdent un peu de leur conductivité pour la retrouver par après. 

### 2.2 : deuxième modèle #####################################################################################

# chargement des ensembles de paramètres par défaut pour la simulation CRootBox.
```{r}
rparam2 <- read_rparam(path = "inputs/crootbox_source/modelparameter/maize_p2.rparam")
pparam2 <- read_pparam(path = "inputs/crootbox_source/modelparameter/maize_p2.pparam")
```


# Vérifiez les paramètres des fichiers

```{r}
head(rparam2)
```

# Run crootbox
```{r}
system("inputs/crootbox.exe") # Run crootbox for windows
```


# obtenir les résultats de la simulation
```{r}
rootsystem_2 <- fread("outputs/current_rootsystem.txt", header = T)
```


# Plot l'architecture du système racinaire
```{r}
rootsystem_2 %>%
  ggplot() +
  theme_classic() +
  geom_segment(aes(x = x1, y = z1, xend = x2, yend = z2), alpha=0.8) +
  coord_fixed()

```

#sauvegarde du plot du système racinaire
```{r}
rootsystem_plot <- fread("outputs/current_rootsystem.txt", header = T)
plot <- rootsystem_plot %>%
  ggplot() +
  theme_classic() +
  geom_segment(aes(x = x1, y = z1, xend = x2, yend = z2), alpha=0.8) +
  coord_fixed() +
  ggtitle("Architecture of the root system")  

save_path <- "C:\\crootbox-marshal\\crootbox-marshal\\outputs\\images\\root_system_architecture_plot_2.png"

ggsave(save_path, plot, width = 6, height = 4, units = "in")
ggsave("root_system_plot_2.png", plot, width = 6, height = 4, units = "in")
```


# Plot l'anatomie du système racinaire

# Recoder la colonne "type" avec des noms descriptifs
```{r}
rootsystem_anat <- rootsystem_2 %>%
  mutate(type = recode(type, 
                       `1` = "Tap root", 
                       `2` = "Lateral", 
                       `3` = "Second-order lateral", 
                       `4` = "Basal root"))

```

# s'assurer que le type est bien un facteur
```{r}
rootsystem_anat$type <- as.factor(rootsystem_anat$type)
```


# définir les couleurs
```{r}
my_colors <- c("Tap root" = "blue", "Lateral" = "red", "Second-order lateral" = "yellow", "Basal root" = "orange")
```


# Plot le système racinaire
```{r}
rootsystem_anat %>%
  ggplot() +
  theme_classic() +
  geom_segment(aes(x = x1, y = z1, xend = x2, yend = z2, col = type), alpha = 0.8) +
  coord_fixed() +
  scale_color_manual(name = "Root Type", values = my_colors)  # Change legend name and colors
```


#sauvegarde du plot du système racinaire
```{r}
plot <- rootsystem_anat %>%
  ggplot() +
  theme_classic() +
  geom_segment(aes(x = x1, y = z1, xend = x2, yend = z2, col = type), alpha = 0.8) +
  coord_fixed() +
  scale_color_manual(name = "Root Type", values = my_colors) +  # Change legend name and colors
  ggtitle("Anatomy of the root system") 

save_path <- "C:\\crootbox-marshal\\crootbox-marshal\\outputs\\images\\root_system_anatomy_plot_2.png"

ggsave(save_path, plot, width = 6, height = 4, units = "in")
ggsave("root_system_plot_2.png", plot, width = 6, height = 4, units = "in")
```


# chargement des ensembles de paramètres par défaut pour la simulation MARSHAL 
```{r}
psiCollar <- -15000 #force initiale de pression tirant l'eau hors de la plante
soil <- read_csv("inputs/soil.csv")
conductivities <- read_csv("inputs/conductivities.csv")

head(conductivities)
print(soil)
```


# Run MARSHAL
```{r}
hydraulics <- getSUF(rootsystem_2, conductivities, soil, psiCollar)
```


# Mapper les résultats à l'échelle du segment sur le système racinaire
```{r}
hydraulic_archi_2 <- hydraulics$root_system
hydraulic_archi_2$suf <- hydraulics$suf[,1]
hydraulic_archi_2$kr <- hydraulics$kr[,1]
hydraulic_archi_2$kx <- hydraulics$kx[,1]
hydraulic_archi_2$jr <- hydraulics$jr[,1]
hydraulic_archi_2$jxl <- hydraulics$jxl[,1]
```


# Obtenir les résultats à l'échelle de la plante
```{r}
print(paste0("Root system conductivity = ",hydraulics$krs))
print(paste0("Root system transpiration = ",hydraulics$tact))
hydraulics_krs_2 <- hydraulics$krs
```



# Plot les résultats
```{r}
hydraulic_archi_2 %>%
  ggplot() +
  theme_classic() +
  geom_segment(aes(x = x1, y = z1, xend = x2, yend = z2, col = suf), alpha=0.8) +
  scale_color_viridis_c() + 
  coord_fixed()


plot <- hydraulic_archi_2 %>%
  ggplot() +
  theme_classic() +
  geom_segment(aes(x = x1, y = z1, xend = x2, yend = z2, col = suf), alpha=0.8) +
  scale_color_viridis_c() + 
  coord_fixed() +
  ggtitle("SUF of the root system")  
save_path <- "C:\\crootbox-marshal\\crootbox-marshal\\outputs\\images\\hydraulic_archi_plot_Suf_2.png"


ggsave(save_path, plot, width = 6, height = 4, units = "in")
ggsave("hydraulic_archi_1_2.png", plot, width = 6, height = 4, units = "in")


hydraulic_archi_2 %>%
  ggplot() +
  theme_classic() +
  geom_segment(aes(x = x1, y = z1, xend = x2, yend = z2, col = kr), alpha=0.8) +
  scale_color_viridis_c() + 
  coord_fixed()

plot <- hydraulic_archi_2 %>%
  ggplot() +
  theme_classic() +
  geom_segment(aes(x = x1, y = z1, xend = x2, yend = z2, col = kr), alpha=0.8) +
  scale_color_viridis_c() + 
  coord_fixed() +
  ggtitle("Kr of the root system")

save_path <- "C:\\crootbox-marshal\\crootbox-marshal\\outputs\\images\\hydraulic_archi_plot_Kr_2.png"

ggsave(save_path, plot, width = 6, height = 4, units = "in")
ggsave("hydraulic_archi_1_2.png", plot, width = 6, height = 4, units = "in")
```
#Observations 

Correspondent aux observations citées pour le modèle 1. 

### 2.3 : troisième modèle #####################################################################################

# Chargement des ensembles de paramètres par défaut pour la simulation CRootBox
```{r}
rparam3 <- read_rparam(path = "inputs/crootbox_source/modelparameter/maize_p3.rparam")
pparam3 <- read_pparam(path = "inputs/crootbox_source/modelparameter/maize_p3.pparam")
```


# vérifier les paramètres des fichiers
```{r}
head(rparam3)
```


# Run crootbox
```{r}
system("inputs/crootbox.exe") # Run crootbox for windows

```

# Obtenir les résultats de la simulation
```{r}
rootsystem_3 <- fread("outputs/current_rootsystem.txt", header = T)
```


# Plot l'architecture du système racinaire
```{r}
rootsystem_3 %>%
  ggplot() +
  theme_classic() +
  geom_segment(aes(x = x1, y = z1, xend = x2, yend = z2), alpha=0.8) +
  coord_fixed()
```


#sauve du plot du système racinaire
```{r}
rootsystem_plot <- fread("outputs/current_rootsystem.txt", header = T)
plot <- rootsystem_plot %>%
  ggplot() +
  theme_classic() +
  geom_segment(aes(x = x1, y = z1, xend = x2, yend = z2), alpha=0.8) +
  coord_fixed() +
  ggtitle("Architecture of the root system")  

save_path <- "C:\\crootbox-marshal\\crootbox-marshal\\outputs\\images\\root_system_architecture_plot_3.png"

ggsave(save_path, plot, width = 6, height = 4, units = "in")
ggsave("root_system_plot_3.png", plot, width = 6, height = 4, units = "in")
```


# Plot l'anatomie du système racinaire

# Recoder la colonne "type" avec des noms descriptifs
```{r}
rootsystem_anat <- rootsystem_3 %>%
  mutate(type = recode(type, 
                       `1` = "Tap root", 
                       `2` = "Lateral", 
                       `3` = "Second-order lateral", 
                       `4` = "Basal root"))
```


# S'assurer que le type est un facteur
```{r}
rootsystem_anat$type <- as.factor(rootsystem_anat$type)
```


# Définir les couleurs
```{r}
my_colors <- c("Tap root" = "blue", "Lateral" = "red", "Second-order lateral" = "yellow", "Basal root" = "orange")
```


# Plot le système racinaire
```{r}
rootsystem_anat %>%
  ggplot() +
  theme_classic() +
  geom_segment(aes(x = x1, y = z1, xend = x2, yend = z2, col = type), alpha = 0.8) +
  coord_fixed() +
  scale_color_manual(name = "Root Type", values = my_colors)  # Change legend name and colors
```


#sauvegarde du plot du système racinaire
```{r}
plot <- rootsystem_anat %>%
  ggplot() +
  theme_classic() +
  geom_segment(aes(x = x1, y = z1, xend = x2, yend = z2, col = type), alpha = 0.8) +
  coord_fixed() +
  scale_color_manual(name = "Root Type", values = my_colors) +  # Change legend name and colors
  ggtitle("Anatomy of the root system") 

save_path <- "C:\\crootbox-marshal\\crootbox-marshal\\outputs\\images\\root_system_anatomy_plot_3.png"

ggsave(save_path, plot, width = 6, height = 4, units = "in")
ggsave("root_system_plot_3.png", plot, width = 6, height = 4, units = "in")
```


# Chargement des ensembles de paramètres par défaut pour la simulation MARSHAL 
```{r}
psiCollar <- -15000 #force initiale de pression tirant l'eau hors de la plante
soil <- read_csv("inputs/soil.csv")
conductivities <- read_csv("inputs/conductivities.csv")

head(conductivities)
print(soil)
```


# Run MARSHAL
```{r}
hydraulics <- getSUF(rootsystem_3, conductivities, soil, psiCollar)

```

# Mapper les résultats à l'échelle du segment sur le système racinaire
```{r}
hydraulic_archi_3 <- hydraulics$root_system
hydraulic_archi_3$suf <- hydraulics$suf[,1]
hydraulic_archi_3$kr <- hydraulics$kr[,1]
hydraulic_archi_3$kx <- hydraulics$kx[,1]
hydraulic_archi_3$jr <- hydraulics$jr[,1]
hydraulic_archi_3$jxl <- hydraulics$jxl[,1]
```


# Obtenir les résultats à l'échelle de la plante

```{r}
print(paste0("Root system conductivity = ",hydraulics$krs))
print(paste0("Root system transpiration = ",hydraulics$tact))
hydraulics_krs_3 <- hydraulics$krs
```


# Plot les résultats
```{r}
hydraulic_archi_3 %>%
  ggplot() +
  theme_classic() +
  geom_segment(aes(x = x1, y = z1, xend = x2, yend = z2, col = suf), alpha=0.8) +
  scale_color_viridis_c() + 
  coord_fixed()


plot <- hydraulic_archi_3 %>%
  ggplot() +
  theme_classic() +
  geom_segment(aes(x = x1, y = z1, xend = x2, yend = z2, col = suf), alpha=0.8) +
  scale_color_viridis_c() + 
  coord_fixed() +
  ggtitle("SUF of the root system")  
save_path <- "C:\\crootbox-marshal\\crootbox-marshal\\outputs\\images\\hydraulic_archi_plot_Suf_3.png"


ggsave(save_path, plot, width = 6, height = 4, units = "in")
ggsave("hydraulic_archi_1_2.png", plot, width = 6, height = 4, units = "in")


hydraulic_archi_3 %>%
  ggplot() +
  theme_classic() +
  geom_segment(aes(x = x1, y = z1, xend = x2, yend = z2, col = kr), alpha=0.8) +
  scale_color_viridis_c() + 
  coord_fixed()

plot <- hydraulic_archi_3 %>%
  ggplot() +
  theme_classic() +
  geom_segment(aes(x = x1, y = z1, xend = x2, yend = z2, col = kr), alpha=0.8) +
  scale_color_viridis_c() + 
  coord_fixed() +
  ggtitle("Kr of the root system")

save_path <- "C:\\crootbox-marshal\\crootbox-marshal\\outputs\\images\\hydraulic_archi_plot_Kr_3.png"

ggsave(save_path, plot, width = 6, height = 4, units = "in")
ggsave("hydraulic_archi_1_2.png", plot, width = 6, height = 4, units = "in")
```
#Observations 

Correspondent aux observations citées pour le modèle 1 et 2. 

A noter cependant, qu'on observe une corrélation entre la conductivité et la transpiration du système racinaire. En effet, si l'on compare les 3 modèles, on remarque qu'au plus le Krs est grand au plus le système sera apte à transpiré.

### 3 : APSIM model #####################################################################################

Dans cette section, le modèle APSIM est utilisé afin de simuler la croissance d'une culture de Maïs du jour 30 au 60. Les paramètres utilisés se concentre sur la croissance racinaire, l'absorption de l'eau ainsi que la production de biomasse. 



### Variables Initiales ###

```{r}
DAS <- c(30:60) # Modelization duration from day 30 to 60
```

# Profondeurs initiales pour chaque couche de sol
```{r}
DEPTH1 <- 300
DEPTH2 <- 300
DEPTH3 <- 300
```

# Taux de croissance des racines (mm/jour)
```{r}
RGR <- 20
```

# Eaux du sol disponibles
```{r}
ASW1 <- 40
ASW2 <- 30
ASW3 <- 30
```

# Fraction de pression de vapeur saturée
```{r}
SVP_FRACT <- 0.75
```

# Efficacité d'utilisation du rayonnement
```{r}
RUE <- 1.6
```

# Coefficient d'efficacité de la transpiration
```{r}
TEC <- 9
```

# Taux d'extraction constant de la culture
```{r}
KL <- 0.07
```

# Indice de surface foliaire
```{r}
LAI <- 1.5
POTENTIAL_DLAI <- 0.1
```

# Coefficient d'extinction de la lumière
```{r}
K <- 0.45
```

# Ratios initiales
```{r}
SD1 <- 0.5
SD2 <- 1.5
SD3 <- 4
```

# Biomasse initiale
```{r}
INIT_BIOMASS <- 45
```


# Données fournies et NON calculées

```{r}
initial_measurements <- read_excel("inputs\\mes_in.xls", sheet = 4)
```


### Data calculées ##

```{r}
saturated_vapor_pressure <- function(temp){
  # Units are in kPA and so we divide by 10
  (6.1078 * exp((17.269 * temp) / (temp + 237.3))) * 0.1
}

vapor_pressure_deficit <- function(svp_fract, svp_min, svp_max){
  # The input is in kPA and we use hPA so multiply by 10
  svp_fract * (svp_max - svp_min) * 10
}

initial_measurements["svp(Tmin)"] <- saturated_vapor_pressure(initial_measurements$Tmin)
initial_measurements["svp(Tmax)"] <- saturated_vapor_pressure(initial_measurements$Tmax)
initial_measurements["VPDcalc"] <- vapor_pressure_deficit(SVP_FRACT, 
                                                          initial_measurements["svp(Tmin)"],
                                                          initial_measurements["svp(Tmax)"])

```

# Dataframe & information

```{r}
root_depth <- sapply(DAS * RGR, min, DEPTH1+DEPTH2+DEPTH3)

make_pot_supply1 <- function(rdepth, asw, kl){
  ifelse(rdepth >= DEPTH1, 1, rdepth/DEPTH1) * asw * kl
}

make_pot_supply2 <- function(rdepth, asw, kl){
  ifelse(rdepth <= DEPTH1, 0, ifelse(rdepth > DEPTH1 + DEPTH2, 1, (rdepth - DEPTH1) / DEPTH2)) * asw * kl
}

make_pot_supply3 <- function(rdepth, asw, kl){
  ifelse(rdepth <= DEPTH1 + DEPTH2, 0, (rdepth - DEPTH1 - DEPTH2)/DEPTH3) * asw * kl
}

make_leaf_exp_effect <- function(SDratio){
  ifelse(SDratio <= SD1, 0, ifelse(SDratio > SD2, 1, (SDratio - SD1)/(SD2 - SD1)))
}

gen_supply_and_demand_low <- function(rdepth, initial_measures){
  ### Setting the initial states ###
  # Supply side
  asw1 <- c(ASW1)
  asw2 <- c(ASW2)
  asw3 <- c(ASW3)
  tot_asw <- c(ASW1 + ASW2 + ASW3)
  ps1 <- c(make_pot_supply1(rdepth[1], ASW1, KL))
  ps2 <- c(make_pot_supply2(rdepth[1], ASW2, KL))
  ps3 <- c(make_pot_supply3(rdepth[1], ASW3, KL))
  pot_supply <- c(ps1[1] + ps2[1] + ps3[1])
  # Demand side
  lai <- c(LAI)
  li <- c(1 - exp(-K * LAI))
  pot_demand <- c(initial_measures$Radn[1]*li[1]*RUE / (TEC/(initial_measures$VPDcalc[1]/10)))
  supply_on_demand <- c(pot_supply[1] / pot_demand[1])
  leaf_exp_effect <- c(make_leaf_exp_effect(supply_on_demand[1]))
  delta_lai <- c(leaf_exp_effect[1] * POTENTIAL_DLAI)
  transpiration <- c(min(pot_supply[1], pot_demand[1]))
  bio_water <- c(transpiration[1] * (TEC /(initial_measures$VPDcalc[1]/10)))
  bio_light <- c(initial_measures$Radn[1] * li[1] * RUE)
  delta_biomass <- c(ifelse(supply_on_demand[1] > 1, bio_light[1], bio_water[1]))
  sum_biomass <- c(INIT_BIOMASS + delta_biomass[1])
  # Loop over
  for (i in 2:length(DAS)){
    # Demand side
    asw1[i] <- asw1[i - 1] - ps1[i - 1] / pot_supply[i - 1] * transpiration[i - 1]
    asw2[i] <- asw2[i - 1] - ps2[i - 1] / pot_supply[i - 1] * transpiration[i - 1]
    asw3[i] <- asw3[i - 1] - ps3[i - 1] / pot_supply[i - 1] * transpiration[i - 1]
    tot_asw[i] <- asw1[i] + asw2[i] + asw3[i]
    ps1[i] <- make_pot_supply1(rdepth[i], asw1[i], KL)
    ps2[i] <- make_pot_supply2(rdepth[i], asw2[i], KL)
    ps3[i] <- make_pot_supply3(rdepth[i], asw3[i], KL)
    pot_supply[i] <- ps1[i] + ps2[i] + ps3[i]
    # Supply side
    lai[i] <- lai[i - 1] + delta_lai[i - 1]
    li[i] <- 1 - exp(-K * lai[i])
    pot_demand[i] <- c(initial_measures$Radn[i]*li[i]*RUE / (TEC/(initial_measures$VPDcalc[i]/10)))
    supply_on_demand[i] <- pot_supply[i] / pot_demand[i]
    leaf_exp_effect[i] <- make_leaf_exp_effect(supply_on_demand[i])
    delta_lai[i] <- leaf_exp_effect[i] * POTENTIAL_DLAI
    transpiration[i] <- min(pot_supply[i], pot_demand[i])
    bio_water[i] <- transpiration[i] * (TEC / (initial_measures$VPDcalc[i] / 10))
    bio_light[i] <- initial_measures$Radn[i] * li[i] * RUE
    delta_biomass[i] <- ifelse(supply_on_demand[i] > 1, bio_light[i], bio_water[i])
    sum_biomass[i] <- sum_biomass[i - 1] + delta_biomass[i]
  }
  sum_water_used <- cumsum(transpiration)
  supply_df_low <- data.frame(
    "DAS" = DAS,
    "ASW1"=  asw1,
    "ASW2" =  asw2,
    "ASW3" =  asw3,
    "Tot ASW" = tot_asw,
    "Root depth" = root_depth,
    "PS1" =  ps1,
    "PS2" =  ps2,
    "PS3" =  ps3,
    "Pot Supply" =  pot_supply
  )
  demand_df_low <- data.frame(
    "LAI" =  lai,
    "LI" =  li,
    "Pot Demand" = pot_demand,
    "S/D" = supply_on_demand,
    "LeafExpEffect" = leaf_exp_effect,
    "Delta LAI" = delta_lai,
    "Transpiration" = transpiration,
    "Sum Water Use" = sum_water_used,
    "Bio Water" = bio_water,
    "Bio Light" = bio_light,
    "Delta Biomass" =  delta_biomass,
    "Sum Biomass" =  sum_biomass
  )
  return(list("Supply DF LOW" = supply_df_low, "Demand DF LOW" = demand_df_low))
}


result_low <- gen_supply_and_demand_low(root_depth, initial_measurements)

print(result_low)
```


# Export dataframe
```{r}
write.csv2(result_low$`Supply DF LOW`, "outputs/APSIM/supply_df_low_apsim.csv")
write.csv2(result_low$`Demand DF LOW`, "outputs/APSIM/demand_df_low_apsim.csv")
```


# Load dataframe 
```{r}
file_path <- "outputs/APSIM/demand_df_low_apsim.csv"
demand_df_apsim <- fread(file_path)
```


# Print la dernière ligne de la colonne "sum_biomass"
```{r}
demand_df_apsim %>%
  pull(V13) %>%
  tail(1) %>%
  print()
```
#Observations 

On observe que les racines s'enfoncent plus profondéments pendant 15 jours avant de se stabiliser à une certaines profondeur. C'est également aux environs de ce 15ème jour, que la demande en eau et la quantité de biomasse commencent à réduire. 

On peut imaginer que c'est à ce moment que la plante démarre un stade d'équilibre où ses racines n'ont plus besoin de s'enfoncer plus profondément afin de permettre à la plante de subsister à son stade adulte. 

La profondeur atteinte semble être cohérente car il est rare d'observer des plants de Maïs descendant à plus de 90cm de profondeur (1). 

## 4 : Analyse #####################################################################################

### 4.1 : Influence de la profondeur racinaire  #####################################################################################

Dans cette section, l'influence de la profondeur racinaire sur la croissance de la culture ainsi que l'utilisation de son eau sera analysée. 

Afin de calculer la profondeur racinaires maximales, la profondeur initiales se basera sur les données calculées aux points 2 via CrootBox. 
3 analyses seront donc effectuée suivant les mêmes raisons déjà citées au point 2.


#### 4.1.1 : APSIM case 1  #####################################################################################

# Créer un vecteur vide pour stocker la profondeur des racines pour chaque jour
```{r}
root_depth_1 <- numeric(length = 60)  # Assuming 60 days
```


# Itérer sur chaque jour
```{r}
for (i in 30:60) {
  # Define the time range for the current day
  t_max <- i
  
  # Subset the data for the current day
  day_data_1 <- subset(rootsystem_1, time <= t_max)
  
  # Find the maximum depth for the current day
  max_depth_1 <- abs(min(day_data_1$z2))
  
  # Store the maximum depth for the current day as root depth
  root_depth_1[i] <- max_depth_1
}

make_pot_supply1 <- function(rdepth, asw, kl){
  ifelse(rdepth >= DEPTH1, 1, rdepth/DEPTH1) * asw * kl
}

make_pot_supply2 <- function(rdepth, asw, kl){
  ifelse(rdepth <= DEPTH1, 0, ifelse(rdepth > DEPTH1 + DEPTH2, 1, (rdepth - DEPTH1) / DEPTH2)) * asw * kl
}

make_pot_supply3 <- function(rdepth, asw, kl){
  ifelse(rdepth <= DEPTH1 + DEPTH2, 0, (rdepth - DEPTH1 - DEPTH2)/DEPTH3) * asw * kl
}

make_leaf_exp_effect <- function(SDratio){
  ifelse(SDratio <= SD1, 0, ifelse(SDratio > SD2, 1, (SDratio - SD1)/(SD2 - SD1)))
}

```

# Définir une valeur seuil proche de zéro
```{r}
threshold <- 1e-5
```


# Filtrer les valeurs proches de zéro
```{r}
root_depth_1 <- root_depth_1[abs(root_depth_1) > threshold]

gen_supply_and_demand_low <- function(rdepth, initial_measures){
  ### Setting the initial states ###
  # Supply side
  asw1 <- c(ASW1)
  asw2 <- c(ASW2)
  asw3 <- c(ASW3)
  tot_asw <- c(ASW1 + ASW2 + ASW3)
  ps1 <- c(make_pot_supply1(rdepth[1], ASW1, KL))
  ps2 <- c(make_pot_supply2(rdepth[1], ASW2, KL))
  ps3 <- c(make_pot_supply3(rdepth[1], ASW3, KL))
  pot_supply <- c(ps1[1] + ps2[1] + ps3[1])
  # Demand side
  lai <- c(LAI)
  li <- c(1 - exp(-K * LAI))
  pot_demand <- c(initial_measures$Radn[1]*li[1]*RUE / (TEC/(initial_measures$VPDcalc[1]/10)))
  supply_on_demand <- c(pot_supply[1] / pot_demand[1])
  leaf_exp_effect <- c(make_leaf_exp_effect(supply_on_demand[1]))
  delta_lai <- c(leaf_exp_effect[1] * POTENTIAL_DLAI)
  transpiration <- c(min(pot_supply[1], pot_demand[1]))
  bio_water <- c(transpiration[1] * (TEC /(initial_measures$VPDcalc[1]/10)))
  bio_light <- c(initial_measures$Radn[1] * li[1] * RUE)
  delta_biomass <- c(ifelse(supply_on_demand[1] > 1, bio_light[1], bio_water[1]))
  sum_biomass <- c(INIT_BIOMASS + delta_biomass[1])
  # Loop over
  for (i in 2:length(DAS)){
    # Demand side
    asw1[i] <- asw1[i - 1] - ps1[i - 1] / pot_supply[i - 1] * transpiration[i - 1]
    asw2[i] <- asw2[i - 1] - ps2[i - 1] / pot_supply[i - 1] * transpiration[i - 1]
    asw3[i] <- asw3[i - 1] - ps3[i - 1] / pot_supply[i - 1] * transpiration[i - 1]
    tot_asw[i] <- asw1[i] + asw2[i] + asw3[i]
    ps1[i] <- make_pot_supply1(rdepth[i], asw1[i], KL)
    ps2[i] <- make_pot_supply2(rdepth[i], asw2[i], KL)
    ps3[i] <- make_pot_supply3(rdepth[i], asw3[i], KL)
    pot_supply[i] <- ps1[i] + ps2[i] + ps3[i]
    # Supply side
    lai[i] <- lai[i - 1] + delta_lai[i - 1]
    li[i] <- 1 - exp(-K * lai[i])
    pot_demand[i] <- c(initial_measures$Radn[i]*li[i]*RUE / (TEC/(initial_measures$VPDcalc[i]/10)))
    supply_on_demand[i] <- pot_supply[i] / pot_demand[i]
    leaf_exp_effect[i] <- make_leaf_exp_effect(supply_on_demand[i])
    delta_lai[i] <- leaf_exp_effect[i] * POTENTIAL_DLAI
    transpiration[i] <- min(pot_supply[i], pot_demand[i])
    bio_water[i] <- transpiration[i] * (TEC / (initial_measures$VPDcalc[i] / 10))
    bio_light[i] <- initial_measures$Radn[i] * li[i] * RUE
    delta_biomass[i] <- ifelse(supply_on_demand[i] > 1, bio_light[i], bio_water[i])
    sum_biomass[i] <- sum_biomass[i - 1] + delta_biomass[i]
  }
  sum_water_used <- cumsum(transpiration)
  supply_df_low <- data.frame(
    "DAS" = DAS,
    "ASW1"=  asw1,
    "ASW2" =  asw2,
    "ASW3" =  asw3,
    "Tot ASW" = tot_asw,
    "Root depth" = root_depth_1,
    "PS1" =  ps1,
    "PS2" =  ps2,
    "PS3" =  ps3,
    "Pot Supply" =  pot_supply
  )
  demand_df_low <- data.frame(
    "LAI" =  lai,
    "LI" =  li,
    "Pot Demand" = pot_demand,
    "S/D" = supply_on_demand,
    "LeafExpEffect" = leaf_exp_effect,
    "Delta LAI" = delta_lai,
    "Transpiration" = transpiration,
    "Sum Water Use" = sum_water_used,
    "Bio Water" = bio_water,
    "Bio Light" = bio_light,
    "Delta Biomass" =  delta_biomass,
    "Sum Biomass" =  sum_biomass
  )
  return(list("Supply DF LOW" = supply_df_low, "Demand DF LOW" = demand_df_low))
}

result_low <- gen_supply_and_demand_low(root_depth_1, initial_measurements)

print(result_low)
```


# Export dataframe
```{r}
write.csv2(result_low$`Supply DF LOW`, "outputs/APSIM/supply_df_low_1.csv")
write.csv2(result_low$`Demand DF LOW`, "outputs/APSIM/demand_df_low_1.csv")
```



#### 4.1.2 : APSIM case 2  #####################################################################################

# Créer un vecteur vide pour stocker la profondeur des racines pour chaque jour
```{r}
root_depth_2 <- numeric(length = 60)  # Assuming 60 days
```


# Itérer sur chaque jour
```{r}
for (i in 30:60) {
  # Define the time range for the current day
  t_max <- i
  
  # Subset the data for the current day
  day_data_2 <- subset(rootsystem_2, time <= t_max)
  
  # Find the maximum depth for the current day
  max_depth_2 <- abs(min(day_data_2$z2))
  
  # Store the maximum depth for the current day as root depth
  root_depth_2[i] <- max_depth_2
}

make_pot_supply1 <- function(rdepth, asw, kl){
  ifelse(rdepth >= DEPTH1, 1, rdepth/DEPTH1) * asw * kl
}

make_pot_supply2 <- function(rdepth, asw, kl){
  ifelse(rdepth <= DEPTH1, 0, ifelse(rdepth > DEPTH1 + DEPTH2, 1, (rdepth - DEPTH1) / DEPTH2)) * asw * kl
}

make_pot_supply3 <- function(rdepth, asw, kl){
  ifelse(rdepth <= DEPTH1 + DEPTH2, 0, (rdepth - DEPTH1 - DEPTH2)/DEPTH3) * asw * kl
}

make_leaf_exp_effect <- function(SDratio){
  ifelse(SDratio <= SD1, 0, ifelse(SDratio > SD2, 1, (SDratio - SD1)/(SD2 - SD1)))
}
```


# Définir une valeur seuil proche de zéro
```{r}
threshold <- 1e-5
```


# Filtrer les valeurs proches de zéro
```{r}
root_depth_2 <- root_depth_2[abs(root_depth_2) > threshold]

gen_supply_and_demand_low <- function(rdepth, initial_measures){
  ### Setting the initial states ###
  # Supply side
  asw1 <- c(ASW1)
  asw2 <- c(ASW2)
  asw3 <- c(ASW3)
  tot_asw <- c(ASW1 + ASW2 + ASW3)
  ps1 <- c(make_pot_supply1(rdepth[1], ASW1, KL))
  ps2 <- c(make_pot_supply2(rdepth[1], ASW2, KL))
  ps3 <- c(make_pot_supply3(rdepth[1], ASW3, KL))
  pot_supply <- c(ps1[1] + ps2[1] + ps3[1])
  # Demand side
  lai <- c(LAI)
  li <- c(1 - exp(-K * LAI))
  pot_demand <- c(initial_measures$Radn[1]*li[1]*RUE / (TEC/(initial_measures$VPDcalc[1]/10)))
  supply_on_demand <- c(pot_supply[1] / pot_demand[1])
  leaf_exp_effect <- c(make_leaf_exp_effect(supply_on_demand[1]))
  delta_lai <- c(leaf_exp_effect[1] * POTENTIAL_DLAI)
  transpiration <- c(min(pot_supply[1], pot_demand[1]))
  bio_water <- c(transpiration[1] * (TEC /(initial_measures$VPDcalc[1]/10)))
  bio_light <- c(initial_measures$Radn[1] * li[1] * RUE)
  delta_biomass <- c(ifelse(supply_on_demand[1] > 1, bio_light[1], bio_water[1]))
  sum_biomass <- c(INIT_BIOMASS + delta_biomass[1])
  # Loop over
  for (i in 2:length(DAS)){
    # Demand side
    asw1[i] <- asw1[i - 1] - ps1[i - 1] / pot_supply[i - 1] * transpiration[i - 1]
    asw2[i] <- asw2[i - 1] - ps2[i - 1] / pot_supply[i - 1] * transpiration[i - 1]
    asw3[i] <- asw3[i - 1] - ps3[i - 1] / pot_supply[i - 1] * transpiration[i - 1]
    tot_asw[i] <- asw1[i] + asw2[i] + asw3[i]
    ps1[i] <- make_pot_supply1(rdepth[i], asw1[i], KL)
    ps2[i] <- make_pot_supply2(rdepth[i], asw2[i], KL)
    ps3[i] <- make_pot_supply3(rdepth[i], asw3[i], KL)
    pot_supply[i] <- ps1[i] + ps2[i] + ps3[i]
    # Supply side
    lai[i] <- lai[i - 1] + delta_lai[i - 1]
    li[i] <- 1 - exp(-K * lai[i])
    pot_demand[i] <- c(initial_measures$Radn[i]*li[i]*RUE / (TEC/(initial_measures$VPDcalc[i]/10)))
    supply_on_demand[i] <- pot_supply[i] / pot_demand[i]
    leaf_exp_effect[i] <- make_leaf_exp_effect(supply_on_demand[i])
    delta_lai[i] <- leaf_exp_effect[i] * POTENTIAL_DLAI
    transpiration[i] <- min(pot_supply[i], pot_demand[i])
    bio_water[i] <- transpiration[i] * (TEC / (initial_measures$VPDcalc[i] / 10))
    bio_light[i] <- initial_measures$Radn[i] * li[i] * RUE
    delta_biomass[i] <- ifelse(supply_on_demand[i] > 1, bio_light[i], bio_water[i])
    sum_biomass[i] <- sum_biomass[i - 1] + delta_biomass[i]
  }
  sum_water_used <- cumsum(transpiration)
  supply_df_low <- data.frame(
    "DAS" = DAS,
    "ASW1"=  asw1,
    "ASW2" =  asw2,
    "ASW3" =  asw3,
    "Tot ASW" = tot_asw,
    "Root depth" = root_depth_2,
    "PS1" =  ps1,
    "PS2" =  ps2,
    "PS3" =  ps3,
    "Pot Supply" =  pot_supply
  )
  demand_df_low <- data.frame(
    "LAI" =  lai,
    "LI" =  li,
    "Pot Demand" = pot_demand,
    "S/D" = supply_on_demand,
    "LeafExpEffect" = leaf_exp_effect,
    "Delta LAI" = delta_lai,
    "Transpiration" = transpiration,
    "Sum Water Use" = sum_water_used,
    "Bio Water" = bio_water,
    "Bio Light" = bio_light,
    "Delta Biomass" =  delta_biomass,
    "Sum Biomass" =  sum_biomass
  )
  return(list("Supply DF LOW" = supply_df_low, "Demand DF LOW" = demand_df_low))
}

result_low <- gen_supply_and_demand_low(root_depth_2, initial_measurements)

print(result_low)
```


# Export dataframe
```{r}
write.csv2(result_low$`Supply DF LOW`, "outputs/APSIM/supply_df_low_2.csv")
write.csv2(result_low$`Demand DF LOW`, "outputs/APSIM/demand_df_low_2.csv")
```


#### 4.1.3 : APSIM case 3  #####################################################################################

# Créer un vecteur vide pour stocker la profondeur des racines pour chaque jour
```{r}
root_depth_3 <- numeric(length = 60)  # Assuming 60 days
```


# Itérer sur chaque jour
```{r}
for (i in 30:60) {
  # Define the time range for the current day
  t_max <- i
  
  # Subset the data for the current day
  day_data_3 <- subset(rootsystem_3, time <= t_max)
  
  # Find the maximum depth for the current day
  max_depth_3 <- abs(min(day_data_3$z2))
  
  # Store the maximum depth for the current day as root depth
  root_depth_3[i] <- max_depth_3
}

make_pot_supply1 <- function(rdepth, asw, kl){
  ifelse(rdepth >= DEPTH1, 1, rdepth/DEPTH1) * asw * kl
}

make_pot_supply2 <- function(rdepth, asw, kl){
  ifelse(rdepth <= DEPTH1, 0, ifelse(rdepth > DEPTH1 + DEPTH2, 1, (rdepth - DEPTH1) / DEPTH2)) * asw * kl
}

make_pot_supply3 <- function(rdepth, asw, kl){
  ifelse(rdepth <= DEPTH1 + DEPTH2, 0, (rdepth - DEPTH1 - DEPTH2)/DEPTH3) * asw * kl
}

make_leaf_exp_effect <- function(SDratio){
  ifelse(SDratio <= SD1, 0, ifelse(SDratio > SD2, 1, (SDratio - SD1)/(SD2 - SD1)))
}
```


# Définir une valeur seuil proche de zéro
```{r}
threshold <- 1e-5
```


# Filtrer les valeurs proches de zéro
```{r}
root_depth_3 <- root_depth_3[abs(root_depth_3) > threshold]

gen_supply_and_demand_low <- function(rdepth, initial_measures){
  ### Setting the initial states ###
  # Supply side
  asw1 <- c(ASW1)
  asw2 <- c(ASW2)
  asw3 <- c(ASW3)
  tot_asw <- c(ASW1 + ASW2 + ASW3)
  ps1 <- c(make_pot_supply1(rdepth[1], ASW1, KL))
  ps2 <- c(make_pot_supply2(rdepth[1], ASW2, KL))
  ps3 <- c(make_pot_supply3(rdepth[1], ASW3, KL))
  pot_supply <- c(ps1[1] + ps2[1] + ps3[1])
  # Demand side
  lai <- c(LAI)
  li <- c(1 - exp(-K * LAI))
  pot_demand <- c(initial_measures$Radn[1]*li[1]*RUE / (TEC/(initial_measures$VPDcalc[1]/10)))
  supply_on_demand <- c(pot_supply[1] / pot_demand[1])
  leaf_exp_effect <- c(make_leaf_exp_effect(supply_on_demand[1]))
  delta_lai <- c(leaf_exp_effect[1] * POTENTIAL_DLAI)
  transpiration <- c(min(pot_supply[1], pot_demand[1]))
  bio_water <- c(transpiration[1] * (TEC /(initial_measures$VPDcalc[1]/10)))
  bio_light <- c(initial_measures$Radn[1] * li[1] * RUE)
  delta_biomass <- c(ifelse(supply_on_demand[1] > 1, bio_light[1], bio_water[1]))
  sum_biomass <- c(INIT_BIOMASS + delta_biomass[1])
  # Loop over
  for (i in 2:length(DAS)){
    # Demand side
    asw1[i] <- asw1[i - 1] - ps1[i - 1] / pot_supply[i - 1] * transpiration[i - 1]
    asw2[i] <- asw2[i - 1] - ps2[i - 1] / pot_supply[i - 1] * transpiration[i - 1]
    asw3[i] <- asw3[i - 1] - ps3[i - 1] / pot_supply[i - 1] * transpiration[i - 1]
    tot_asw[i] <- asw1[i] + asw2[i] + asw3[i]
    ps1[i] <- make_pot_supply1(rdepth[i], asw1[i], KL)
    ps2[i] <- make_pot_supply2(rdepth[i], asw2[i], KL)
    ps3[i] <- make_pot_supply3(rdepth[i], asw3[i], KL)
    pot_supply[i] <- ps1[i] + ps2[i] + ps3[i]
    # Supply side
    lai[i] <- lai[i - 1] + delta_lai[i - 1]
    li[i] <- 1 - exp(-K * lai[i])
    pot_demand[i] <- c(initial_measures$Radn[i]*li[i]*RUE / (TEC/(initial_measures$VPDcalc[i]/10)))
    supply_on_demand[i] <- pot_supply[i] / pot_demand[i]
    leaf_exp_effect[i] <- make_leaf_exp_effect(supply_on_demand[i])
    delta_lai[i] <- leaf_exp_effect[i] * POTENTIAL_DLAI
    transpiration[i] <- min(pot_supply[i], pot_demand[i])
    bio_water[i] <- transpiration[i] * (TEC / (initial_measures$VPDcalc[i] / 10))
    bio_light[i] <- initial_measures$Radn[i] * li[i] * RUE
    delta_biomass[i] <- ifelse(supply_on_demand[i] > 1, bio_light[i], bio_water[i])
    sum_biomass[i] <- sum_biomass[i - 1] + delta_biomass[i]
  }
  sum_water_used <- cumsum(transpiration)
  supply_df_low <- data.frame(
    "DAS" = DAS,
    "ASW1"=  asw1,
    "ASW2" =  asw2,
    "ASW3" =  asw3,
    "Tot ASW" = tot_asw,
    "Root depth" = root_depth_3,
    "PS1" =  ps1,
    "PS2" =  ps2,
    "PS3" =  ps3,
    "Pot Supply" =  pot_supply
  )
  demand_df_low <- data.frame(
    "LAI" =  lai,
    "LI" =  li,
    "Pot Demand" = pot_demand,
    "S/D" = supply_on_demand,
    "LeafExpEffect" = leaf_exp_effect,
    "Delta LAI" = delta_lai,
    "Transpiration" = transpiration,
    "Sum Water Use" = sum_water_used,
    "Bio Water" = bio_water,
    "Bio Light" = bio_light,
    "Delta Biomass" =  delta_biomass,
    "Sum Biomass" =  sum_biomass
  )
  return(list("Supply DF LOW" = supply_df_low, "Demand DF LOW" = demand_df_low))
}

result_low <- gen_supply_and_demand_low(root_depth_3, initial_measurements)

print(result_low)
```


# Export dataframe
```{r}
write.csv2(result_low$`Supply DF LOW`, "outputs/APSIM/supply_df_low_3.csv")
write.csv2(result_low$`Demand DF LOW`, "outputs/APSIM/demand_df_low_3.csv")
```


#### 4.1.4 : APSIM comparison  #####################################################################################

Désormais, il est possible de comparer les différents systèmes et leurs impacts sur la production de biomasse. 

#apsim
# Chargement du dataframe 
```{r}
file_path <- "outputs/APSIM/demand_df_low_apsim.csv"
demand_df_apsim <- fread(file_path)
```


# Print la dernière ligne de la colonne "sum_biomass"
```{r}
demand_df_apsim %>%
  pull(V13) %>%
  tail(1) %>%
  print()
```


#case 1
# Chargement du dataframe
```{r}
file_path <- "outputs/APSIM/demand_df_low_1.csv"
demand_df_1 <- fread(file_path)
```


# Print la dernière ligne de la colonne "sum_biomass"
```{r}
demand_df_1 %>%
  pull(Sum.Biomass) %>%
  tail(1) %>%
  print()
```


#case 2
# Chargement du dataframe
```{r}
file_path <- "outputs/APSIM/demand_df_low_2.csv"
demand_df_2 <- fread(file_path)
```


# Print la dernière ligne de la colonne "sum_biomass"
```{r}
demand_df_2 %>%
  pull(Sum.Biomass) %>%
  tail(1) %>%
  print
```


#case 3
# Chargement du dataframe
```{r}
file_path <- "outputs/APSIM/demand_df_low_3.csv"
demand_df_3 <- fread(file_path)

```

# Print la dernière ligne de la colonne "sum_biomass"
```{r}
demand_df_3 %>%
  pull(Sum.Biomass) %>%
  tail(1) %>%
  print()
```
#plot des dernières valeurs de la colonne Sum.Biomass
```{r}
# Extraire la dernière valeur de la colonne Sum.Biomass
value_1 <- tail(demand_df_1$Sum.Biomass, 1)
value_2 <- tail(demand_df_2$Sum.Biomass, 1)
value_3 <- tail(demand_df_3$Sum.Biomass, 1)

# Créer un dataframe pour le graphique
data <- data.frame(
  Case = c("Modèle 1", "Modèle 2", "Modèle 3"),
  Value = c(value_1, value_2, value_3)
)

# Créer le graphique à barres
graphique <- ggplot(data, aes(x = Case, y = Value)) +
  geom_bar(stat = "identity", fill = "steelblue", width = 0.5) +
  labs(x = "Modèle", y = "Somme de Biomasse", title = "Somme de Biomasse produite pour chaque modèle")

# Spécifier le chemin complet où sauvegarder le graphique
save_path <- "C:\\crootbox-marshal\\crootbox-marshal\\outputs\\images\\Biomass_model.png"

# Sauvegarde du graphique dans le chemin spécifié
ggsave(save_path, graphique, width = 8, height = 6, dpi = 300)

print(graphique)
```


###Observations 

On observe une corrélation entre la quantité de biomasse produite et la profondeur des racines. 
Les 3 cas possèdent 3 profondeur différents et on observe une corrélation positive montrant qu'au plus le système racinaire descend profondément au plus la quantité de biomasse sera importante. 

Cet observation peut s'expliquer via deux phénomènes. Le premier étant qu'au plus les racines sont profondes au plus elles sont grandes, la plante dispose donc de plus de tissus destiné à l'apport d'eau et de nutriments nécessaire à sa croissance. Le deuxième, s'explique par le fait que les racines étants plus profondes, la réserve d'eau et de nutriments disponible dans le sol augmente également. La plante se trouve donc avec une plus grande quantité disponibles de ces éléments s'autorisant une croissance plus importante. 

Les résultats ne sont cependants pas significatifs et mériteraient une confirmation par les extrêmes en prenants des profondeurs significativement différentes. 

### 4.2 : Influence de Krs  #####################################################################################

#Calcul du Krs standard et de kl

```{r}
kl_std = (0.06+0.05+0.05)/3 #code et calcul de LisonVanAsbrouck 
krs_std = (hydraulics_krs_1+hydraulics_krs_2+hydraulics_krs_3)/3
```


### 4.2.1 : APSIM case 1  #####################################################################################

Une fois les valeurrs standard de Krs calculé via une moyenne pour chaque couche de sol, le paramètre KL peut être ajusté au variation de Krs. 

Cela permets d'évaluer l'influence du paramètre Krs sur la production de biomasse. 

### variables Initiales ###
# Constante du taux d'extraction de la culture
```{r}
KL_1 <- (kl_std*hydraulics_krs_1/krs_std)
```



# Data fournies et *NON* calculées

```{r}
initial_measurements <- read_excel("inputs/mes_in.xls", sheet = 4)
```


### Data calculées ##

```{r}
saturated_vapor_pressure <- function(temp){
  # Units are in kPA and so we divide by 10
  (6.1078 * exp((17.269 * temp) / (temp + 237.3))) * 0.1
}

vapor_pressure_deficit <- function(svp_fract, svp_min, svp_max){
  # The input is in kPA and we use hPA so multiply by 10
  svp_fract * (svp_max - svp_min) * 10
}

initial_measurements["svp(Tmin)"] <- saturated_vapor_pressure(initial_measurements$Tmin)
initial_measurements["svp(Tmax)"] <- saturated_vapor_pressure(initial_measurements$Tmax)
initial_measurements["VPDcalc"] <- vapor_pressure_deficit(SVP_FRACT, 
                                                          initial_measurements["svp(Tmin)"],
                                                          initial_measurements["svp(Tmax)"])
```


# Dataframe & information

```{r}
root_depth <- sapply(DAS * RGR, min, DEPTH1+DEPTH2+DEPTH3)

make_pot_supply1 <- function(rdepth, asw, KL_1){
  ifelse(rdepth >= DEPTH1, 1, rdepth/DEPTH1) * asw * KL_1
}

make_pot_supply2 <- function(rdepth, asw, KL_1){
  ifelse(rdepth <= DEPTH1, 0, ifelse(rdepth > DEPTH1 + DEPTH2, 1, (rdepth - DEPTH1) / DEPTH2)) * asw * KL_1
}

make_pot_supply3 <- function(rdepth, asw, KL_1){
  ifelse(rdepth <= DEPTH1 + DEPTH2, 0, (rdepth - DEPTH1 - DEPTH2)/DEPTH3) * asw * KL_1
}

make_leaf_exp_effect <- function(SDratio){
  ifelse(SDratio <= SD1, 0, ifelse(SDratio > SD2, 1, (SDratio - SD1)/(SD2 - SD1)))
}

gen_supply_and_demand_low <- function(rdepth, initial_measures){
  ### Setting the initial states ###
  # Supply side
  asw1 <- c(ASW1)
  asw2 <- c(ASW2)
  asw3 <- c(ASW3)
  tot_asw <- c(ASW1 + ASW2 + ASW3)
  ps1 <- c(make_pot_supply1(rdepth[1], ASW1, KL_1))
  ps2 <- c(make_pot_supply2(rdepth[1], ASW2, KL_1))
  ps3 <- c(make_pot_supply3(rdepth[1], ASW3, KL_1))
  pot_supply <- c(ps1[1] + ps2[1] + ps3[1])
  # Demand side
  lai <- c(LAI)
  li <- c(1 - exp(-K * LAI))
  pot_demand <- c(initial_measures$Radn[1]*li[1]*RUE / (TEC/(initial_measures$VPDcalc[1]/10)))
  supply_on_demand <- c(pot_supply[1] / pot_demand[1])
  leaf_exp_effect <- c(make_leaf_exp_effect(supply_on_demand[1]))
  delta_lai <- c(leaf_exp_effect[1] * POTENTIAL_DLAI)
  transpiration <- c(min(pot_supply[1], pot_demand[1]))
  bio_water <- c(transpiration[1] * (TEC /(initial_measures$VPDcalc[1]/10)))
  bio_light <- c(initial_measures$Radn[1] * li[1] * RUE)
  delta_biomass <- c(ifelse(supply_on_demand[1] > 1, bio_light[1], bio_water[1]))
  sum_biomass <- c(INIT_BIOMASS + delta_biomass[1])
  # Loop over
  for (i in 2:length(DAS)){
    # Demand side
    asw1[i] <- asw1[i - 1] - ps1[i - 1] / pot_supply[i - 1] * transpiration[i - 1]
    asw2[i] <- asw2[i - 1] - ps2[i - 1] / pot_supply[i - 1] * transpiration[i - 1]
    asw3[i] <- asw3[i - 1] - ps3[i - 1] / pot_supply[i - 1] * transpiration[i - 1]
    tot_asw[i] <- asw1[i] + asw2[i] + asw3[i]
    ps1[i] <- make_pot_supply1(rdepth[i], asw1[i], KL_1)
    ps2[i] <- make_pot_supply2(rdepth[i], asw2[i], KL_1)
    ps3[i] <- make_pot_supply3(rdepth[i], asw3[i], KL_1)
    pot_supply[i] <- ps1[i] + ps2[i] + ps3[i]
    # Supply side
    lai[i] <- lai[i - 1] + delta_lai[i - 1]
    li[i] <- 1 - exp(-K * lai[i])
    pot_demand[i] <- c(initial_measures$Radn[i]*li[i]*RUE / (TEC/(initial_measures$VPDcalc[i]/10)))
    supply_on_demand[i] <- pot_supply[i] / pot_demand[i]
    leaf_exp_effect[i] <- make_leaf_exp_effect(supply_on_demand[i])
    delta_lai[i] <- leaf_exp_effect[i] * POTENTIAL_DLAI
    transpiration[i] <- min(pot_supply[i], pot_demand[i])
    bio_water[i] <- transpiration[i] * (TEC / (initial_measures$VPDcalc[i] / 10))
    bio_light[i] <- initial_measures$Radn[i] * li[i] * RUE
    delta_biomass[i] <- ifelse(supply_on_demand[i] > 1, bio_light[i], bio_water[i])
    sum_biomass[i] <- sum_biomass[i - 1] + delta_biomass[i]
  }
  sum_water_used <- cumsum(transpiration)
  supply_df_low <- data.frame(
    "DAS" = DAS,
    "ASW1"=  asw1,
    "ASW2" =  asw2,
    "ASW3" =  asw3,
    "Tot ASW" = tot_asw,
    "Root depth" = root_depth,
    "PS1" =  ps1,
    "PS2" =  ps2,
    "PS3" =  ps3,
    "Pot Supply" =  pot_supply
  )
  demand_df_low <- data.frame(
    "LAI" =  lai,
    "LI" =  li,
    "Pot Demand" = pot_demand,
    "S/D" = supply_on_demand,
    "LeafExpEffect" = leaf_exp_effect,
    "Delta LAI" = delta_lai,
    "Transpiration" = transpiration,
    "Sum Water Use" = sum_water_used,
    "Bio Water" = bio_water,
    "Bio Light" = bio_light,
    "Delta Biomass" =  delta_biomass,
    "Sum Biomass" =  sum_biomass
  )
  return(list("Supply DF LOW" = supply_df_low, "Demand DF LOW" = demand_df_low))
}


result_low <- gen_supply_and_demand_low(root_depth, initial_measurements)

print(result_low)
```


# Export dataframe
```{r}
write.csv2(result_low$`Supply DF LOW`, "outputs/APSIM/supply_df_low_kl_1.csv")
write.csv2(result_low$`Demand DF LOW`, "outputs/APSIM/demand_df_low_kl_1.csv")
```


### 4.2.2 : APSIM case 2  #####################################################################################

### Variables Initiales ###
# Constante du taux d'extraction de la culture
```{r}
KL_2 <- (kl_std*hydraulics_krs_2/krs_std)
```



# Data fournies et *NON* calculées

```{r}
initial_measurements <- read_excel("inputs/mes_in.xls", sheet = 4)
```


### Data calculées ##

```{r}
saturated_vapor_pressure <- function(temp){
  # Units are in kPA and so we divide by 10
  (6.1078 * exp((17.269 * temp) / (temp + 237.3))) * 0.1
}

vapor_pressure_deficit <- function(svp_fract, svp_min, svp_max){
  # The input is in kPA and we use hPA so multiply by 10
  svp_fract * (svp_max - svp_min) * 10
}

initial_measurements["svp(Tmin)"] <- saturated_vapor_pressure(initial_measurements$Tmin)
initial_measurements["svp(Tmax)"] <- saturated_vapor_pressure(initial_measurements$Tmax)
initial_measurements["VPDcalc"] <- vapor_pressure_deficit(SVP_FRACT, 
                                                          initial_measurements["svp(Tmin)"],
                                                          initial_measurements["svp(Tmax)"])
```


# Dataframe & information

```{r}
root_depth <- sapply(DAS * RGR, min, DEPTH1+DEPTH2+DEPTH3)

make_pot_supply1 <- function(rdepth, asw, KL_2){
  ifelse(rdepth >= DEPTH1, 1, rdepth/DEPTH1) * asw * KL_2
}

make_pot_supply2 <- function(rdepth, asw, KL_2){
  ifelse(rdepth <= DEPTH1, 0, ifelse(rdepth > DEPTH1 + DEPTH2, 1, (rdepth - DEPTH1) / DEPTH2)) * asw * KL_2
}

make_pot_supply3 <- function(rdepth, asw, KL_2){
  ifelse(rdepth <= DEPTH1 + DEPTH2, 0, (rdepth - DEPTH1 - DEPTH2)/DEPTH3) * asw * KL_2
}

make_leaf_exp_effect <- function(SDratio){
  ifelse(SDratio <= SD1, 0, ifelse(SDratio > SD2, 1, (SDratio - SD1)/(SD2 - SD1)))
}

gen_supply_and_demand_low <- function(rdepth, initial_measures){
  ### Setting the initial states ###
  # Supply side
  asw1 <- c(ASW1)
  asw2 <- c(ASW2)
  asw3 <- c(ASW3)
  tot_asw <- c(ASW1 + ASW2 + ASW3)
  ps1 <- c(make_pot_supply1(rdepth[1], ASW1, KL_2))
  ps2 <- c(make_pot_supply2(rdepth[1], ASW2, KL_2))
  ps3 <- c(make_pot_supply3(rdepth[1], ASW3, KL_2))
  pot_supply <- c(ps1[1] + ps2[1] + ps3[1])
  # Demand side
  lai <- c(LAI)
  li <- c(1 - exp(-K * LAI))
  pot_demand <- c(initial_measures$Radn[1]*li[1]*RUE / (TEC/(initial_measures$VPDcalc[1]/10)))
  supply_on_demand <- c(pot_supply[1] / pot_demand[1])
  leaf_exp_effect <- c(make_leaf_exp_effect(supply_on_demand[1]))
  delta_lai <- c(leaf_exp_effect[1] * POTENTIAL_DLAI)
  transpiration <- c(min(pot_supply[1], pot_demand[1]))
  bio_water <- c(transpiration[1] * (TEC /(initial_measures$VPDcalc[1]/10)))
  bio_light <- c(initial_measures$Radn[1] * li[1] * RUE)
  delta_biomass <- c(ifelse(supply_on_demand[1] > 1, bio_light[1], bio_water[1]))
  sum_biomass <- c(INIT_BIOMASS + delta_biomass[1])
  # Loop over
  for (i in 2:length(DAS)){
    # Demand side
    asw1[i] <- asw1[i - 1] - ps1[i - 1] / pot_supply[i - 1] * transpiration[i - 1]
    asw2[i] <- asw2[i - 1] - ps2[i - 1] / pot_supply[i - 1] * transpiration[i - 1]
    asw3[i] <- asw3[i - 1] - ps3[i - 1] / pot_supply[i - 1] * transpiration[i - 1]
    tot_asw[i] <- asw1[i] + asw2[i] + asw3[i]
    ps1[i] <- make_pot_supply1(rdepth[i], asw1[i], KL_2)
    ps2[i] <- make_pot_supply2(rdepth[i], asw2[i], KL_2)
    ps3[i] <- make_pot_supply3(rdepth[i], asw3[i], KL_2)
    pot_supply[i] <- ps1[i] + ps2[i] + ps3[i]
    # Supply side
    lai[i] <- lai[i - 1] + delta_lai[i - 1]
    li[i] <- 1 - exp(-K * lai[i])
    pot_demand[i] <- c(initial_measures$Radn[i]*li[i]*RUE / (TEC/(initial_measures$VPDcalc[i]/10)))
    supply_on_demand[i] <- pot_supply[i] / pot_demand[i]
    leaf_exp_effect[i] <- make_leaf_exp_effect(supply_on_demand[i])
    delta_lai[i] <- leaf_exp_effect[i] * POTENTIAL_DLAI
    transpiration[i] <- min(pot_supply[i], pot_demand[i])
    bio_water[i] <- transpiration[i] * (TEC / (initial_measures$VPDcalc[i] / 10))
    bio_light[i] <- initial_measures$Radn[i] * li[i] * RUE
    delta_biomass[i] <- ifelse(supply_on_demand[i] > 1, bio_light[i], bio_water[i])
    sum_biomass[i] <- sum_biomass[i - 1] + delta_biomass[i]
  }
  sum_water_used <- cumsum(transpiration)
  supply_df_low <- data.frame(
    "DAS" = DAS,
    "ASW1"=  asw1,
    "ASW2" =  asw2,
    "ASW3" =  asw3,
    "Tot ASW" = tot_asw,
    "Root depth" = root_depth,
    "PS1" =  ps1,
    "PS2" =  ps2,
    "PS3" =  ps3,
    "Pot Supply" =  pot_supply
  )
  demand_df_low <- data.frame(
    "LAI" =  lai,
    "LI" =  li,
    "Pot Demand" = pot_demand,
    "S/D" = supply_on_demand,
    "LeafExpEffect" = leaf_exp_effect,
    "Delta LAI" = delta_lai,
    "Transpiration" = transpiration,
    "Sum Water Use" = sum_water_used,
    "Bio Water" = bio_water,
    "Bio Light" = bio_light,
    "Delta Biomass" =  delta_biomass,
    "Sum Biomass" =  sum_biomass
  )
  return(list("Supply DF LOW" = supply_df_low, "Demand DF LOW" = demand_df_low))
}


result_low <- gen_supply_and_demand_low(root_depth, initial_measurements)

print(result_low)
```


# Export dataframe
```{r}
write.csv2(result_low$`Supply DF LOW`, "outputs/APSIM/supply_df_low_KL_2.csv")
write.csv2(result_low$`Demand DF LOW`, "outputs/APSIM/demand_df_low_KL_2.csv")
```


### 4.2.3 : APSIM case 3  #####################################################################################

### Variables Initiales ###
# Constante du taux d'extraction de la culture
```{r}
KL_3 <- (kl_std*hydraulics_krs_3/krs_std)
```



# Data fournies et NON calculées

```{r}
initial_measurements <- read_excel("inputs/mes_in.xls", sheet = 4)
```


### Data calculées ##

```{r}
saturated_vapor_pressure <- function(temp){
  # Units are in kPA and so we divide by 10
  (6.1078 * exp((17.269 * temp) / (temp + 237.3))) * 0.1
}

vapor_pressure_deficit <- function(svp_fract, svp_min, svp_max){
  # The input is in kPA and we use hPA so multiply by 10
  svp_fract * (svp_max - svp_min) * 10
}

initial_measurements["svp(Tmin)"] <- saturated_vapor_pressure(initial_measurements$Tmin)
initial_measurements["svp(Tmax)"] <- saturated_vapor_pressure(initial_measurements$Tmax)
initial_measurements["VPDcalc"] <- vapor_pressure_deficit(SVP_FRACT, 
                                                          initial_measurements["svp(Tmin)"],
                                                          initial_measurements["svp(Tmax)"])

```

# Dataframe & information

```{r}
root_depth <- sapply(DAS * RGR, min, DEPTH1+DEPTH2+DEPTH3)

make_pot_supply1 <- function(rdepth, asw, KL_3){
  ifelse(rdepth >= DEPTH1, 1, rdepth/DEPTH1) * asw * KL_3
}

make_pot_supply2 <- function(rdepth, asw, KL_3){
  ifelse(rdepth <= DEPTH1, 0, ifelse(rdepth > DEPTH1 + DEPTH2, 1, (rdepth - DEPTH1) / DEPTH2)) * asw * KL_3
}

make_pot_supply3 <- function(rdepth, asw, KL_3){
  ifelse(rdepth <= DEPTH1 + DEPTH2, 0, (rdepth - DEPTH1 - DEPTH2)/DEPTH3) * asw * KL_3
}

make_leaf_exp_effect <- function(SDratio){
  ifelse(SDratio <= SD1, 0, ifelse(SDratio > SD2, 1, (SDratio - SD1)/(SD2 - SD1)))
}

gen_supply_and_demand_low <- function(rdepth, initial_measures){
  ### Setting the initial states ###
  # Supply side
  asw1 <- c(ASW1)
  asw2 <- c(ASW2)
  asw3 <- c(ASW3)
  tot_asw <- c(ASW1 + ASW2 + ASW3)
  ps1 <- c(make_pot_supply1(rdepth[1], ASW1, KL_3))
  ps2 <- c(make_pot_supply2(rdepth[1], ASW2, KL_3))
  ps3 <- c(make_pot_supply3(rdepth[1], ASW3, KL_3))
  pot_supply <- c(ps1[1] + ps2[1] + ps3[1])
  # Demand side
  lai <- c(LAI)
  li <- c(1 - exp(-K * LAI))
  pot_demand <- c(initial_measures$Radn[1]*li[1]*RUE / (TEC/(initial_measures$VPDcalc[1]/10)))
  supply_on_demand <- c(pot_supply[1] / pot_demand[1])
  leaf_exp_effect <- c(make_leaf_exp_effect(supply_on_demand[1]))
  delta_lai <- c(leaf_exp_effect[1] * POTENTIAL_DLAI)
  transpiration <- c(min(pot_supply[1], pot_demand[1]))
  bio_water <- c(transpiration[1] * (TEC /(initial_measures$VPDcalc[1]/10)))
  bio_light <- c(initial_measures$Radn[1] * li[1] * RUE)
  delta_biomass <- c(ifelse(supply_on_demand[1] > 1, bio_light[1], bio_water[1]))
  sum_biomass <- c(INIT_BIOMASS + delta_biomass[1])
  # Loop over
  for (i in 2:length(DAS)){
    # Demand side
    asw1[i] <- asw1[i - 1] - ps1[i - 1] / pot_supply[i - 1] * transpiration[i - 1]
    asw2[i] <- asw2[i - 1] - ps2[i - 1] / pot_supply[i - 1] * transpiration[i - 1]
    asw3[i] <- asw3[i - 1] - ps3[i - 1] / pot_supply[i - 1] * transpiration[i - 1]
    tot_asw[i] <- asw1[i] + asw2[i] + asw3[i]
    ps1[i] <- make_pot_supply1(rdepth[i], asw1[i], KL_3)
    ps2[i] <- make_pot_supply2(rdepth[i], asw2[i], KL_3)
    ps3[i] <- make_pot_supply3(rdepth[i], asw3[i], KL_3)
    pot_supply[i] <- ps1[i] + ps2[i] + ps3[i]
    # Supply side
    lai[i] <- lai[i - 1] + delta_lai[i - 1]
    li[i] <- 1 - exp(-K * lai[i])
    pot_demand[i] <- c(initial_measures$Radn[i]*li[i]*RUE / (TEC/(initial_measures$VPDcalc[i]/10)))
    supply_on_demand[i] <- pot_supply[i] / pot_demand[i]
    leaf_exp_effect[i] <- make_leaf_exp_effect(supply_on_demand[i])
    delta_lai[i] <- leaf_exp_effect[i] * POTENTIAL_DLAI
    transpiration[i] <- min(pot_supply[i], pot_demand[i])
    bio_water[i] <- transpiration[i] * (TEC / (initial_measures$VPDcalc[i] / 10))
    bio_light[i] <- initial_measures$Radn[i] * li[i] * RUE
    delta_biomass[i] <- ifelse(supply_on_demand[i] > 1, bio_light[i], bio_water[i])
    sum_biomass[i] <- sum_biomass[i - 1] + delta_biomass[i]
  }
  sum_water_used <- cumsum(transpiration)
  supply_df_low <- data.frame(
    "DAS" = DAS,
    "ASW1"=  asw1,
    "ASW2" =  asw2,
    "ASW3" =  asw3,
    "Tot ASW" = tot_asw,
    "Root depth" = root_depth,
    "PS1" =  ps1,
    "PS2" =  ps2,
    "PS3" =  ps3,
    "Pot Supply" =  pot_supply
  )
  demand_df_low <- data.frame(
    "LAI" =  lai,
    "LI" =  li,
    "Pot Demand" = pot_demand,
    "S/D" = supply_on_demand,
    "LeafExpEffect" = leaf_exp_effect,
    "Delta LAI" = delta_lai,
    "Transpiration" = transpiration,
    "Sum Water Use" = sum_water_used,
    "Bio Water" = bio_water,
    "Bio Light" = bio_light,
    "Delta Biomass" =  delta_biomass,
    "Sum Biomass" =  sum_biomass
  )
  return(list("Supply DF LOW" = supply_df_low, "Demand DF LOW" = demand_df_low))
}


result_low <- gen_supply_and_demand_low(root_depth, initial_measurements)

print(result_low)
```


# Export dataframe
```{r}
write.csv2(result_low$`Supply DF LOW`, "outputs/APSIM/supply_df_low_KL_3.csv")
write.csv2(result_low$`Demand DF LOW`, "outputs/APSIM/demand_df_low_KL_3.csv")
```


### 4.2.4 : APSIM comparaison  #####################################################################################


#apsim
# Print la dernière ligne de la colonne "sum_biomass"
```{r}
demand_df_apsim %>%
  pull(V13) %>%
  tail(1) %>%
  print()

```

#case 1
# Chargement du dataframe 
```{r}
file_path <- "outputs/APSIM/demand_df_low_kl_1.csv"
demand_df_kl_1 <- fread(file_path)
```


# Print la dernière ligne de la colonne "sum_biomass" 
```{r}
demand_df_kl_1 %>%
  pull(V13) %>%
  tail(1) %>%
  print()
```


#case 2
# Chargement du dataframe 
```{r}
file_path <- "outputs/APSIM/demand_df_low_kl_2.csv"
demand_df_kl_2 <- fread(file_path)
```


# Print la dernière ligne de la colonne "sum_biomass"
```{r}
demand_df_kl_2 %>%
  pull(V13) %>%
  tail(1) %>%
  print
```


#case 3
# Chargement du dataframe 
```{r}
file_path <- "outputs/APSIM/demand_df_low_kl_3.csv"
demand_df_kl_3 <- fread(file_path)
```


# Print la dernière ligne de la colonne "sum_biomass"
```{r}
demand_df_kl_3 %>%
  pull(V13) %>%
  tail(1) %>%
  print()

```
#plot des dernières valeurs de la colonne Sum.Biomass

```{r}
# Extraire la dernière valeur de la colonne V13
value_kl_1 <- tail(demand_df_kl_1$V13, 1)
value_kl_2 <- tail(demand_df_kl_2$V13, 1)
value_kl_3 <- tail(demand_df_kl_3$V13, 1)

# Créer un dataframe pour le graphique
data_kl <- data.frame(
  Case = c("Modèle 1", "Modèle 2", "Modèle 3"),
  Value = c(value_kl_1, value_kl_2, value_kl_3)
)

# Créer le graphique à barres
graphique <- ggplot(data_kl, aes(x = Case, y = Value)) +
  geom_bar(stat = "identity", fill = "steelblue", width = 0.5) +
  labs(x = "Modèle", y = "Somme de Biomasse", title = "Somme de Biomasse produite pour chaque modèle")

# Spécifier le chemin complet où sauvegarder le graphique
save_path <- "C:\\crootbox-marshal\\crootbox-marshal\\outputs\\images\\Biommas_comparison.png"

# Sauvegarde du graphique dans le chemin spécifié
ggsave(save_path, graphique, width = 8, height = 6, dpi = 300)

print(graphique)
```


#observations 

Avec les Krs trouvé au point 2, étant respectivement de 0.066 pour le modèle 1, 0.060 pour le modèle 2 et 0.069 pour le modèle 3. On observe une corrélation où au plus le krs est grand au plus la plante pourra produire de la biomasse.

Le Krs étant la capacité du système racinaire à conduire l'eau aux parties supérieurs de la plante, explique le lien avec la production de biomasse car au plus vite la plante à accès aux nutriments nécessaire pour croitre au mieux elle pourra les répartir efficacement, augmentant son rendement. 

Cependant, encore une fois, les données étant très proche elles pourraient être peu significatives. Une nouvelle modélisation modifiant de façon plus importante les Krs peut être envisagée. 

### 5 : Conditions de sécheresse #####################################################################################

Dans cette section, le même procédé qu'au point 4.1 est utilisé. Cependant, cette fois, les modèles seront soumis à des conditions de sécheresses. 

Cela permettra par la suite de comparer l'influence de la sécheresse sur la production de biomasse. 
# Eaux du sol disponibles
```{r}
ASW1_dry <- 20
ASW2_dry <- 20
ASW3_dry <- 20
```


### 5.1 : APSIM case 1  #####################################################################################
# Créer un vecteur vide pour stocker la profondeur des racines pour chaque jour
```{r}
root_depth_1 <- numeric(length = 60)  # Assuming 60 days
```


# Itérer sur chaque jour
```{r}
for (i in 30:60) {
  # Define the time range for the current day
  t_max <- i
  
  # Subset the data for the current day
  day_data_1 <- subset(rootsystem_1, time <= t_max)
  
  # Find the maximum depth for the current day
  max_depth_1 <- abs(min(day_data_1$z2))
  
  # Store the maximum depth for the current day as root depth
  root_depth_1[i] <- max_depth_1
}

make_pot_supply1 <- function(rdepth, asw, kl_1){
  ifelse(rdepth >= DEPTH1, 1, rdepth/DEPTH1) * asw * KL_1
}

make_pot_supply2 <- function(rdepth, asw, kl_1){
  ifelse(rdepth <= DEPTH1, 0, ifelse(rdepth > DEPTH1 + DEPTH2, 1, (rdepth - DEPTH1) / DEPTH2)) * asw * KL_1
}

make_pot_supply3 <- function(rdepth, asw, kl_1){
  ifelse(rdepth <= DEPTH1 + DEPTH2, 0, (rdepth - DEPTH1 - DEPTH2)/DEPTH3) * asw * KL_1
}

make_leaf_exp_effect <- function(SDratio){
  ifelse(SDratio <= SD1, 0, ifelse(SDratio > SD2, 1, (SDratio - SD1)/(SD2 - SD1)))
}

```

# Définir une valeur seuil proche de zéro
```{r}
threshold <- 1e-5
```


# Filtrer les valeurs proches de zéro
```{r}
root_depth_1 <- root_depth_1[abs(root_depth_1) > threshold]

gen_supply_and_demand_low <- function(rdepth, initial_measures){
  ### Setting the initial states ###
  # Supply side
  asw1 <- c(ASW1)
  asw2 <- c(ASW2)
  asw3 <- c(ASW3)
  tot_asw <- c(ASW1 + ASW2 + ASW3)
  ps1 <- c(make_pot_supply1(rdepth[1], ASW1, KL_1))
  ps2 <- c(make_pot_supply2(rdepth[1], ASW2, KL_1))
  ps3 <- c(make_pot_supply3(rdepth[1], ASW3, KL_1))
  pot_supply <- c(ps1[1] + ps2[1] + ps3[1])
  # Demand side
  lai <- c(LAI)
  li <- c(1 - exp(-K * LAI))
  pot_demand <- c(initial_measures$Radn[1]*li[1]*RUE / (TEC/(initial_measures$VPDcalc[1]/10)))
  supply_on_demand <- c(pot_supply[1] / pot_demand[1])
  leaf_exp_effect <- c(make_leaf_exp_effect(supply_on_demand[1]))
  delta_lai <- c(leaf_exp_effect[1] * POTENTIAL_DLAI)
  transpiration <- c(min(pot_supply[1], pot_demand[1]))
  bio_water <- c(transpiration[1] * (TEC /(initial_measures$VPDcalc[1]/10)))
  bio_light <- c(initial_measures$Radn[1] * li[1] * RUE)
  delta_biomass <- c(ifelse(supply_on_demand[1] > 1, bio_light[1], bio_water[1]))
  sum_biomass <- c(INIT_BIOMASS + delta_biomass[1])
  # Loop over
  for (i in 2:length(DAS)){
    # Demand side
    asw1[i] <- asw1[i - 1] - ps1[i - 1] / pot_supply[i - 1] * transpiration[i - 1]
    asw2[i] <- asw2[i - 1] - ps2[i - 1] / pot_supply[i - 1] * transpiration[i - 1]
    asw3[i] <- asw3[i - 1] - ps3[i - 1] / pot_supply[i - 1] * transpiration[i - 1]
    tot_asw[i] <- asw1[i] + asw2[i] + asw3[i]
    ps1[i] <- make_pot_supply1(rdepth[i], asw1[i], KL_1)
    ps2[i] <- make_pot_supply2(rdepth[i], asw2[i], KL_1)
    ps3[i] <- make_pot_supply3(rdepth[i], asw3[i], KL_1)
    pot_supply[i] <- ps1[i] + ps2[i] + ps3[i]
    # Supply side
    lai[i] <- lai[i - 1] + delta_lai[i - 1]
    li[i] <- 1 - exp(-K * lai[i])
    pot_demand[i] <- c(initial_measures$Radn[i]*li[i]*RUE / (TEC/(initial_measures$VPDcalc[i]/10)))
    supply_on_demand[i] <- pot_supply[i] / pot_demand[i]
    leaf_exp_effect[i] <- make_leaf_exp_effect(supply_on_demand[i])
    delta_lai[i] <- leaf_exp_effect[i] * POTENTIAL_DLAI
    transpiration[i] <- min(pot_supply[i], pot_demand[i])
    bio_water[i] <- transpiration[i] * (TEC / (initial_measures$VPDcalc[i] / 10))
    bio_light[i] <- initial_measures$Radn[i] * li[i] * RUE
    delta_biomass[i] <- ifelse(supply_on_demand[i] > 1, bio_light[i], bio_water[i])
    sum_biomass[i] <- sum_biomass[i - 1] + delta_biomass[i]
  }
  sum_water_used <- cumsum(transpiration)
  supply_df_low <- data.frame(
    "DAS" = DAS,
    "ASW1"=  asw1,
    "ASW2" =  asw2,
    "ASW3" =  asw3,
    "Tot ASW" = tot_asw,
    "Root depth" = root_depth_1,
    "PS1" =  ps1,
    "PS2" =  ps2,
    "PS3" =  ps3,
    "Pot Supply" =  pot_supply
  )
  demand_df_low <- data.frame(
    "LAI" =  lai,
    "LI" =  li,
    "Pot Demand" = pot_demand,
    "S/D" = supply_on_demand,
    "LeafExpEffect" = leaf_exp_effect,
    "Delta LAI" = delta_lai,
    "Transpiration" = transpiration,
    "Sum Water Use" = sum_water_used,
    "Bio Water" = bio_water,
    "Bio Light" = bio_light,
    "Delta Biomass" =  delta_biomass,
    "Sum Biomass" =  sum_biomass
  )
  return(list("Supply DF LOW" = supply_df_low, "Demand DF LOW" = demand_df_low))
}


result_low <- gen_supply_and_demand_low(root_depth_1, initial_measurements)

print(result_low)
```


# Export dataframe
```{r}
write.csv2(result_low$`Supply DF LOW`, "outputs/APSIM/supply_df_low_dry_1.csv")
write.csv2(result_low$`Demand DF LOW`, "outputs/APSIM/demand_df_low_dry_1.csv")
```


### 5.2 : APSIM case 2  #####################################################################################
# Créer un vecteur vide pour stocker la profondeur des racines pour chaque jour
```{r}
root_depth_2 <- numeric(length = 60)  # Assuming 60 days

```

# Itérer sur chaque jour
```{r}
for (i in 30:60) {
  # Define the time range for the current day
  t_max <- i
  
  # Subset the data for the current day
  day_data_2 <- subset(rootsystem_2, time <= t_max)
  
  # Find the maximum depth for the current day
  max_depth_2 <- abs(min(day_data_2$z2))
  
  # Store the maximum depth for the current day as root depth
  root_depth_2[i] <- max_depth_2
}

make_pot_supply1 <- function(rdepth, asw, kl_2){
  ifelse(rdepth >= DEPTH1, 1, rdepth/DEPTH1) * asw * KL_2
}

make_pot_supply2 <- function(rdepth, asw, kl_2){
  ifelse(rdepth <= DEPTH1, 0, ifelse(rdepth > DEPTH1 + DEPTH2, 1, (rdepth - DEPTH1) / DEPTH2)) * asw * KL_2
}

make_pot_supply3 <- function(rdepth, asw, kl_2){
  ifelse(rdepth <= DEPTH1 + DEPTH2, 0, (rdepth - DEPTH1 - DEPTH2)/DEPTH3) * asw * KL_2
}

make_leaf_exp_effect <- function(SDratio){
  ifelse(SDratio <= SD1, 0, ifelse(SDratio > SD2, 1, (SDratio - SD1)/(SD2 - SD1)))
}
```


# Définir une valeur seuil proche de zéro
```{r}
threshold <- 1e-5
```


# Filtrer les valeurs proches de zéro
```{r}
root_depth_2 <- root_depth_2[abs(root_depth_2) > threshold]

gen_supply_and_demand_low <- function(rdepth, initial_measures){
  ### Setting the initial states ###
  # Supply side
  asw1 <- c(ASW1)
  asw2 <- c(ASW2)
  asw3 <- c(ASW3)
  tot_asw <- c(ASW1 + ASW2 + ASW3)
  ps1 <- c(make_pot_supply1(rdepth[1], ASW1, kl_2))
  ps2 <- c(make_pot_supply2(rdepth[1], ASW2, kl_2))
  ps3 <- c(make_pot_supply3(rdepth[1], ASW3, kl_2))
  pot_supply <- c(ps1[1] + ps2[1] + ps3[1])
  # Demand side
  lai <- c(LAI)
  li <- c(1 - exp(-K * LAI))
  pot_demand <- c(initial_measures$Radn[1]*li[1]*RUE / (TEC/(initial_measures$VPDcalc[1]/10)))
  supply_on_demand <- c(pot_supply[1] / pot_demand[1])
  leaf_exp_effect <- c(make_leaf_exp_effect(supply_on_demand[1]))
  delta_lai <- c(leaf_exp_effect[1] * POTENTIAL_DLAI)
  transpiration <- c(min(pot_supply[1], pot_demand[1]))
  bio_water <- c(transpiration[1] * (TEC /(initial_measures$VPDcalc[1]/10)))
  bio_light <- c(initial_measures$Radn[1] * li[1] * RUE)
  delta_biomass <- c(ifelse(supply_on_demand[1] > 1, bio_light[1], bio_water[1]))
  sum_biomass <- c(INIT_BIOMASS + delta_biomass[1])
  # Loop over
  for (i in 2:length(DAS)){
    # Demand side
    asw1[i] <- asw1[i - 1] - ps1[i - 1] / pot_supply[i - 1] * transpiration[i - 1]
    asw2[i] <- asw2[i - 1] - ps2[i - 1] / pot_supply[i - 1] * transpiration[i - 1]
    asw3[i] <- asw3[i - 1] - ps3[i - 1] / pot_supply[i - 1] * transpiration[i - 1]
    tot_asw[i] <- asw1[i] + asw2[i] + asw3[i]
    ps1[i] <- make_pot_supply1(rdepth[i], asw1[i], kl_2)
    ps2[i] <- make_pot_supply2(rdepth[i], asw2[i], kl_2)
    ps3[i] <- make_pot_supply3(rdepth[i], asw3[i], kl_2)
    pot_supply[i] <- ps1[i] + ps2[i] + ps3[i]
    # Supply side
    lai[i] <- lai[i - 1] + delta_lai[i - 1]
    li[i] <- 1 - exp(-K * lai[i])
    pot_demand[i] <- c(initial_measures$Radn[i]*li[i]*RUE / (TEC/(initial_measures$VPDcalc[i]/10)))
    supply_on_demand[i] <- pot_supply[i] / pot_demand[i]
    leaf_exp_effect[i] <- make_leaf_exp_effect(supply_on_demand[i])
    delta_lai[i] <- leaf_exp_effect[i] * POTENTIAL_DLAI
    transpiration[i] <- min(pot_supply[i], pot_demand[i])
    bio_water[i] <- transpiration[i] * (TEC / (initial_measures$VPDcalc[i] / 10))
    bio_light[i] <- initial_measures$Radn[i] * li[i] * RUE
    delta_biomass[i] <- ifelse(supply_on_demand[i] > 1, bio_light[i], bio_water[i])
    sum_biomass[i] <- sum_biomass[i - 1] + delta_biomass[i]
  }
  sum_water_used <- cumsum(transpiration)
  supply_df_low <- data.frame(
    "DAS" = DAS,
    "ASW1"=  asw1,
    "ASW2" =  asw2,
    "ASW3" =  asw3,
    "Tot ASW" = tot_asw,
    "Root depth" = root_depth_2,
    "PS1" =  ps1,
    "PS2" =  ps2,
    "PS3" =  ps3,
    "Pot Supply" =  pot_supply
  )
  demand_df_low <- data.frame(
    "LAI" =  lai,
    "LI" =  li,
    "Pot Demand" = pot_demand,
    "S/D" = supply_on_demand,
    "LeafExpEffect" = leaf_exp_effect,
    "Delta LAI" = delta_lai,
    "Transpiration" = transpiration,
    "Sum Water Use" = sum_water_used,
    "Bio Water" = bio_water,
    "Bio Light" = bio_light,
    "Delta Biomass" =  delta_biomass,
    "Sum Biomass" =  sum_biomass
  )
  return(list("Supply DF LOW" = supply_df_low, "Demand DF LOW" = demand_df_low))
}


result_low <- gen_supply_and_demand_low(root_depth_2, initial_measurements)

print(result_low)
```


# Export dataframe
```{r}
write.csv2(result_low$`Supply DF LOW`, "outputs/APSIM/supply_df_low_dry_2.csv")
write.csv2(result_low$`Demand DF LOW`, "outputs/APSIM/demand_df_low_dry_2.csv")
```


### 5.3 : APSIM case 3  #####################################################################################
# Créer un vecteur vide pour stocker la profondeur des racines pour chaque jour
```{r}
root_depth_3 <- numeric(length = 60)  # Assuming 60 days
```


# Itérer sur chaque jour
```{r}
for (i in 30:60) {
  # Define the time range for the current day
  t_max <- i
  
  # Subset the data for the current day
  day_data_3 <- subset(rootsystem_3, time <= t_max)
  
  # Find the maximum depth for the current day
  max_depth_3 <- abs(min(day_data_3$z2))
  
  # Store the maximum depth for the current day as root depth
  root_depth_3[i] <- max_depth_3
}

make_pot_supply1 <- function(rdepth, asw, kl_3){
  ifelse(rdepth >= DEPTH1, 1, rdepth/DEPTH1) * asw * KL_3
}

make_pot_supply2 <- function(rdepth, asw, kl_3){
  ifelse(rdepth <= DEPTH1, 0, ifelse(rdepth > DEPTH1 + DEPTH2, 1, (rdepth - DEPTH1) / DEPTH2)) * asw * KL_3
}

make_pot_supply3 <- function(rdepth, asw, kl_3){
  ifelse(rdepth <= DEPTH1 + DEPTH2, 0, (rdepth - DEPTH1 - DEPTH2)/DEPTH3) * asw * KL_3
}

make_leaf_exp_effect <- function(SDratio){
  ifelse(SDratio <= SD1, 0, ifelse(SDratio > SD2, 1, (SDratio - SD1)/(SD2 - SD1)))
}
```


# Définir une valeur seuil proche de zéro
```{r}
threshold <- 1e-5
```


# Filtrer les valeurs proches de zéro
```{r}
root_depth_3 <- root_depth_3[abs(root_depth_3) > threshold]

gen_supply_and_demand_low <- function(rdepth, initial_measures){
  ### Setting the initial states ###
  # Supply side
  asw1 <- c(ASW1)
  asw2 <- c(ASW2)
  asw3 <- c(ASW3)
  tot_asw <- c(ASW1 + ASW2 + ASW3)
  ps1 <- c(make_pot_supply1(rdepth[1], ASW1, kl_3))
  ps2 <- c(make_pot_supply2(rdepth[1], ASW2, kl_3))
  ps3 <- c(make_pot_supply3(rdepth[1], ASW3, kl_3))
  pot_supply <- c(ps1[1] + ps2[1] + ps3[1])
  # Demand side
  lai <- c(LAI)
  li <- c(1 - exp(-K * LAI))
  pot_demand <- c(initial_measures$Radn[1]*li[1]*RUE / (TEC/(initial_measures$VPDcalc[1]/10)))
  supply_on_demand <- c(pot_supply[1] / pot_demand[1])
  leaf_exp_effect <- c(make_leaf_exp_effect(supply_on_demand[1]))
  delta_lai <- c(leaf_exp_effect[1] * POTENTIAL_DLAI)
  transpiration <- c(min(pot_supply[1], pot_demand[1]))
  bio_water <- c(transpiration[1] * (TEC /(initial_measures$VPDcalc[1]/10)))
  bio_light <- c(initial_measures$Radn[1] * li[1] * RUE)
  delta_biomass <- c(ifelse(supply_on_demand[1] > 1, bio_light[1], bio_water[1]))
  sum_biomass <- c(INIT_BIOMASS + delta_biomass[1])
  # Loop over
  for (i in 2:length(DAS)){
    # Demand side
    asw1[i] <- asw1[i - 1] - ps1[i - 1] / pot_supply[i - 1] * transpiration[i - 1]
    asw2[i] <- asw2[i - 1] - ps2[i - 1] / pot_supply[i - 1] * transpiration[i - 1]
    asw3[i] <- asw3[i - 1] - ps3[i - 1] / pot_supply[i - 1] * transpiration[i - 1]
    tot_asw[i] <- asw1[i] + asw2[i] + asw3[i]
    ps1[i] <- make_pot_supply1(rdepth[i], asw1[i], kl_3)
    ps2[i] <- make_pot_supply2(rdepth[i], asw2[i], kl_3)
    ps3[i] <- make_pot_supply3(rdepth[i], asw3[i], kl_3)
    pot_supply[i] <- ps1[i] + ps2[i] + ps3[i]
    # Supply side
    lai[i] <- lai[i - 1] + delta_lai[i - 1]
    li[i] <- 1 - exp(-K * lai[i])
    pot_demand[i] <- c(initial_measures$Radn[i]*li[i]*RUE / (TEC/(initial_measures$VPDcalc[i]/10)))
    supply_on_demand[i] <- pot_supply[i] / pot_demand[i]
    leaf_exp_effect[i] <- make_leaf_exp_effect(supply_on_demand[i])
    delta_lai[i] <- leaf_exp_effect[i] * POTENTIAL_DLAI
    transpiration[i] <- min(pot_supply[i], pot_demand[i])
    bio_water[i] <- transpiration[i] * (TEC / (initial_measures$VPDcalc[i] / 10))
    bio_light[i] <- initial_measures$Radn[i] * li[i] * RUE
    delta_biomass[i] <- ifelse(supply_on_demand[i] > 1, bio_light[i], bio_water[i])
    sum_biomass[i] <- sum_biomass[i - 1] + delta_biomass[i]
  }
  sum_water_used <- cumsum(transpiration)
  supply_df_low <- data.frame(
    "DAS" = DAS,
    "ASW1"=  asw1,
    "ASW2" =  asw2,
    "ASW3" =  asw3,
    "Tot ASW" = tot_asw,
    "Root depth" = root_depth_3,
    "PS1" =  ps1,
    "PS2" =  ps2,
    "PS3" =  ps3,
    "Pot Supply" =  pot_supply
  )
  demand_df_low <- data.frame(
    "LAI" =  lai,
    "LI" =  li,
    "Pot Demand" = pot_demand,
    "S/D" = supply_on_demand,
    "LeafExpEffect" = leaf_exp_effect,
    "Delta LAI" = delta_lai,
    "Transpiration" = transpiration,
    "Sum Water Use" = sum_water_used,
    "Bio Water" = bio_water,
    "Bio Light" = bio_light,
    "Delta Biomass" =  delta_biomass,
    "Sum Biomass" =  sum_biomass
  )
  return(list("Supply DF LOW" = supply_df_low, "Demand DF LOW" = demand_df_low))
}


result_low <- gen_supply_and_demand_low(root_depth_3, initial_measurements)

print(result_low)
```


# Export dataframe
```{r}
write.csv2(result_low$`Supply DF LOW`, "outputs/APSIM/supply_df_low_dry_3.csv")
write.csv2(result_low$`Demand DF LOW`, "outputs/APSIM/demand_df_low_dry_3.csv")

```

### 5.4 : APSIM comparaison  #####################################################################################

il est possible de comparer les différents systèmes et leurs impacts sur la production de biomasse en conditions de sécheresse. 

#case 1
# Chargement du dataframe 
```{r}
file_path <- "outputs/APSIM/demand_df_low_dry_1.csv"
demand_df_dry_1 <- fread(file_path)

```

# Print la dernière ligne de la colonne "sum_biomass"
```{r}
demand_df_dry_1 %>%
  pull(Sum.Biomass) %>%
  tail(1) %>%
  print()
```


#case 2
#Chargement du dataframe
```{r}
file_path <- "outputs/APSIM/demand_df_low_dry_2.csv"
demand_df_dry_2 <- fread(file_path)
```


# Print la dernière ligne de la colonne "sum_biomass" 
```{r}
demand_df_dry_2 %>%
  pull(Sum.Biomass) %>%
  tail(1) %>%
  print
```


#case 3
# Chargement du dataframe
```{r}
file_path <- "outputs/APSIM/demand_df_low_dry_3.csv"
demand_df_dry_3 <- fread(file_path)

```

# Print la dernière ligne de la colonne "sum_biomass"
```{r}
demand_df_dry_3 %>%
  pull(Sum.Biomass) %>%
  tail(1) %>%
  print()
```
```{r}
# Extraction de la dernière ligne de chaque dataframe et stockage dans un vecteur
last_biomass <- c(tail(demand_df_dry_1$Sum.Biomass, 1),
                  tail(demand_df_dry_2$Sum.Biomass, 1),
                  tail(demand_df_dry_3$Sum.Biomass, 1))

# Création d'un dataframe pour les données
df <- data.frame(Case = c("Model 1", "Model 2", "Model 3"),
                 Biomass = last_biomass)

# Création du graphique en barres 
graphique <- ggplot(df, aes(x = Case, y = Biomass)) +  
  geom_bar(stat = "identity", width = 0.5) +  
  labs(title = "Comparaison de la production de biomasse entre les trois cas sous conditions de sécheresse",
       x = "Modèle",
       y = "Production de biomasse") +
  theme_minimal()

# Spécifier le chemin complet où sauvegarder le graphique
save_path <- "C:\\crootbox-marshal\\crootbox-marshal\\outputs\\images\\Biommas_under_dry.png"

# Sauvegarde du graphique dans le chemin spécifié
ggsave(save_path, graphique, width = 8, height = 6, dpi = 300)


print(graphique)
```


#Observation

Dans ce cas, où une période de sécheresse est simulée, une corrélation positive entre la profondeur racinaire et la quantité de biomasse produite est observée. La profondeur la plus importante permettant malgré des conditions de sécheresse de garder un rendement plus important que d'autres système moins profond.

De plus, on observe une nette différence en termes de quantité de biomasse produite. Les quantités étant beaucoup plus faible dans ce cas-ci qu'au point 4.1. 

Cependant, encore une fois, les différences ne sont pas significatives et mériteraient une analyse plus approfondies.

#Conclusion

En conclusion, ce rapport efectué dans le cadre du cours de modélisation biologiques LBRAI2219 démontre l'importance de la modélisation, afin de comprendre la croissance de cultures sous diverses conditions. 

Les résultats montrent un impact de la profondeur racinaire sur la production de Biomasse. Une corrélaton positive a été observée entre la profondeur des racines et la quantité de biomasse produite. Permettant de mettre en évidence l'importance d'un système racinaire bien développé afin d'assurer un rendement optimal. 

Ensuite, l'analyse de la conductivité hydraulique(Krs) a également permis d'observer une corrélation positive entre cette dernière et la quantité de biomasse produite. 

Pour finir, le modèle a été soumis à des conditions de sécheresse. On observe une diminution global de la quantité de Biomasse produite. Une corrélation positive est également observée entre la profondeur racinaire et la quantité produite. 

Cependant, toutes les corrélations ne s'observent que sur des écarts relativements faibles. Cela limites la fiabilités des observations et encourage à poursuivre une recherche plus approfondies proposant plus de modèles différents afin de confirmer les corrélations observées.

En résumé, ce rapport propose des moyens d'optimisation des pratiques agricoles afin d'optenir un rendement plus important. Des analyses plus approfondies sont cependant nécessaire pour confirmer ces observations. 


#Co-author et partage de code 
Merci à Joppart Basil pour l'aide technique apportée à mon code ainsi qu'à Lison VanAsbrouck pour son aide technique et théorique pour la partie 4.2 sur l'influence du Krs. 

#Bibliographie
(1) journal Paysan Breton, 2017-08-04, Le point Maïs, consulté le 26-05-2024 sur : https://www.paysan-breton.fr/2017/08/le-point-mais-lextraordinaire-prouesse-des-racines/

(2) ScienceDirect Topics, root hydraulic conductivity, consulté le 26-05-2024 sur : https://www.sciencedirect.com/topics/agricultural-and-biological-sciences/root-hydraulic-conductivity
#END
```{r}
print('The end')
```




